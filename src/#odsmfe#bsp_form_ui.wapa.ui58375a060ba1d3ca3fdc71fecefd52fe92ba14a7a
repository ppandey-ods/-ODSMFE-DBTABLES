sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/Control",                                                                                                                                                                                                                                        
	"jquery.sap.global",                                                                                                                                                                                                                                          
	"./3rd/enketo",                                                                                                                                                                                                                                               
], function (Control, jQuery, Form) {                                                                                                                                                                                                                          
	"use strict";                                                                                                                                                                                                                                                 
	var EnketoFormControl = Control.extend("odsmfe.FormUI.control.EnketoForm", {                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
		// the control API:                                                                                                                                                                                                                                          
		metadata: {                                                                                                                                                                                                                                                  
			properties: {                                                                                                                                                                                                                                               
				formHTMLStr: {                                                                                                                                                                                                                                             
					type: "string",                                                                                                                                                                                                                                           
					defaultValue: ""                                                                                                                                                                                                                                          
				},                                                                                                                                                                                                                                                         
				modelStr: {                                                                                                                                                                                                                                                
					type: "string",                                                                                                                                                                                                                                           
					defaultValue: ""                                                                                                                                                                                                                                          
				},                                                                                                                                                                                                                                                         
				formRecord: {                                                                                                                                                                                                                                              
					type: "string",                                                                                                                                                                                                                                           
					defaultValue: ""                                                                                                                                                                                                                                          
				},                                                                                                                                                                                                                                                         
				formID: {                                                                                                                                                                                                                                                  
					type: "string",                                                                                                                                                                                                                                           
					defaultValue: ""                                                                                                                                                                                                                                          
				},                                                                                                                                                                                                                                                         
				////start  Edit scenario changes                                                                                                                                                                                                                           
				mode: {                                                                                                                                                                                                                                                    
					type: "string",                                                                                                                                                                                                                                           
					defaultValue: ""                                                                                                                                                                                                                                          
				}                                                                                                                                                                                                                                                          
				////End  Edit scenario changes                                                                                                                                                                                                                             
			},                                                                                                                                                                                                                                                          
			aggregations: {                                                                                                                                                                                                                                             
				_busyIndicator: {                                                                                                                                                                                                                                          
					type: "sap.m.BusyDialog",                                                                                                                                                                                                                                 
					multiple: false,                                                                                                                                                                                                                                          
					visibility: "hidden"                                                                                                                                                                                                                                      
				}                                                                                                                                                                                                                                                          
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			events: {                                                                                                                                                                                                                                                   
				enketoFormSubmit: {                                                                                                                                                                                                                                        
					parameters: {                                                                                                                                                                                                                                             
						formRecord: {                                                                                                                                                                                                                                            
							type: "string"                                                                                                                                                                                                                                          
						},                                                                                                                                                                                                                                                       
						isDraft: {                                                                                                                                                                                                                                               
							type: "string"                                                                                                                                                                                                                                          
						},                                                                                                                                                                                                                                                       
						files: {                                                                                                                                                                                                                                                 
							type: "string"                                                                                                                                                                                                                                          
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		init: function () {                                                                                                                                                                                                                                          
			var oBusyIndicator = new sap.m.BusyDialog();                                                                                                                                                                                                                
			oBusyIndicator.setText("Please wait ..");                                                                                                                                                                                                                   
			this.setAggregation("_busyIndicator", oBusyIndicator);                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		renderer: function (oRM, oControl) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			oRM.write("<div id=\"EnketoFormControl\" class=\"main\">");                                                                                                                                                                                                 
			oRM.write("<style scoped>");                                                                                                                                                                                                                                
			oRM.write("@import \"./lib/css/grid.css\"");                                                                                                                                                                                                                
			oRM.write("</style>");                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
			oRM.write("<article class=\"paper\">");                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			/*Footer Header */                                                                                                                                                                                                                                          
			oRM.write("<header class=\"form-header clearfix\">");                                                                                                                                                                                                       
			oRM.write("		<span class=\"form-language-selector hide\"><span>Choose Language</span></span>");                                                                                                                                                             
			oRM.write("		<nav class=\"pages-toc hide\" role=\"navigation\">");                                                                                                                                                                                          
			oRM.write("			<label for=\"toc-toggle\"></label>");                                                                                                                                                                                                         
			oRM.write("			<input type=\"checkbox\" id=\"toc-toggle\" class=\"ignore\" value=\"show\">");                                                                                                                                                                
			oRM.write("			<ul class=\"pages-toc__list\"></ul>");                                                                                                                                                                                                        
			oRM.write("			<div class=\"pages-toc__overlay\"></div>");                                                                                                                                                                                                   
			oRM.write("		</nav>");                                                                                                                                                                                                                                      
			oRM.write("</header>");                                                                                                                                                                                                                                     
			oRM.write("<div id=\"EnketoFormBody\">");                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
			oRM.write("</div>");                                                                                                                                                                                                                                        
			////start  Edit scenario changes                                                                                                                                                                                                                            
			oRM.write("<div id=\"EnketoFormSubmit\">");                                                                                                                                                                                                                 
			oRM.write("</div>");                                                                                                                                                                                                                                        
			////end  Edit scenario changes                                                                                                                                                                                                                              
			oRM.write("</article>");                                                                                                                                                                                                                                    
			oRM.write("</div>");                                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		setFormID: function (sText) {                                                                                                                                                                                                                                
			this.setProperty("formID", sText, true);                                                                                                                                                                                                                    
		},                                                                                                                                                                                                                                                           
		////start  Edit scenario changes                                                                                                                                                                                                                             
		setMode: function (sText) {                                                                                                                                                                                                                                  
			this.setProperty("mode", sText, true);                                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		////End  Edit scenario changes                                                                                                                                                                                                                               
		setFormHTMLStr: function (sText) {                                                                                                                                                                                                                           
			var loadingIndicator = "<div style=\"background-color:lightblue\">" + "<h6>" + "Form " + this.getFormID() + " is loading" +                                                                                                                                 
				"</h6></div>";                                                                                                                                                                                                                                             
			$("#EnketoFormBody").html(loadingIndicator);                                                                                                                                                                                                                
			//When Form HTML is set , Display Busy indicator and update view that Form is Loading.                                                                                                                                                                      
			this.getAggregation("_busyIndicator").open();                                                                                                                                                                                                               
			//Update property&nbsp;                                                                                                                                                                                                                                     
			this.setProperty("formHTMLStr", sText, true);                                                                                                                                                                                                               
			this.getAggregation("_busyIndicator").close();                                                                                                                                                                                                              
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		rerender: function () {                                                                                                                                                                                                                                      
			this.getAggregation("_busyIndicator").close();                                                                                                                                                                                                              
			var sHTML = this.getFormHTMLStr();                                                                                                                                                                                                                          
			var oBusyIndicator = new sap.m.BusyDialog();                                                                                                                                                                                                                
			if (sHTML) {                                                                                                                                                                                                                                                
				oBusyIndicator.open();                                                                                                                                                                                                                                     
				//Set Form HTML in DOM                                                                                                                                                                                                                                     
				this._setHTMLForm();                                                                                                                                                                                                                                       
				//Initlize Form using Enketo Library                                                                                                                                                                                                                       
				this._initializeForm();                                                                                                                                                                                                                                    
				oBusyIndicator.close();                                                                                                                                                                                                                                    
				// this.getAggregation("_busyIndicator").close();                                                                                                                                                                                                          
			} else {                                                                                                                                                                                                                                                    
				//After Enketo Form is rendered , close busy indicator                                                                                                                                                                                                     
				// this.getAggregation("_busyIndicator").close();                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		onBeforeRendering: function () {},                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onAfterRendering: function () {                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
			if (Control.prototype.onAfterRendering) {                                                                                                                                                                                                                   
				Control.prototype.onAfterRendering.apply(this, arguments);                                                                                                                                                                                                 
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			if (!this.isRendered) {                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		_setHTMLForm: function () {                                                                                                                                                                                                                                  
			var div_data = "<div >" + this.getFormHTMLStr() + "</div>";                                                                                                                                                                                                 
			$("#EnketoFormBody").html(div_data);                                                                                                                                                                                                                        
			////**********************start  Edit scenario changes*********************                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			////**********************start code for setting the Form processing Mode                                                                                                                                                                                   
			var mode = this.getMode();                                                                                                                                                                                                                                  
			var footer;                                                                                                                                                                                                                                                 
			var eleEFC = document.getElementById("EnketoFormControl");                                                                                                                                                                                                  
			if (mode === "Edit") {                                                                                                                                                                                                                                      
				footer =                                                                                                                                                                                                                                                   
					"<div class=\"form-footer\"><button id=\"save-as-draft\">Save As Draft</button><button id=\"validate-form\">Submit</button></div>"                                                                                                                        
                                                                                                                                                                                                                                                               
				$("#EnketoFormSubmit").html(footer);                                                                                                                                                                                                                       
				eleEFC.classList.remove("lock");                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			} else if (mode === "Create") {                                                                                                                                                                                                                             
				footer =                                                                                                                                                                                                                                                   
					"<div class=\"form-footer\"><button id=\"save-as-draft\">Save As Draft</button><button id=\"validate-form\">Submit</button></div>"                                                                                                                        
                                                                                                                                                                                                                                                               
				$("#EnketoFormSubmit").html(footer);                                                                                                                                                                                                                       
				eleEFC.classList.remove("lock");                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			} else if (mode === "Display") {                                                                                                                                                                                                                            
				var eleEFC = document.getElementById("EnketoFormBody");                                                                                                                                                                                                    
				footer = "<div ></div>";                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
				$("#EnketoFormSubmit").html(footer);                                                                                                                                                                                                                       
				eleEFC.classList.add('mainBody');                                                                                                                                                                                                                          
				eleEFC.classList.toggle('lock');                                                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			////*****************end code for setting the Form processing Mode                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			////******************end Edit scenario changes******************************                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		getFilename: function (file, postfix) {                                                                                                                                                                                                                      
			var filenameParts;                                                                                                                                                                                                                                          
			if (typeof file === 'object' && file !== null && file.name) {                                                                                                                                                                                               
				postfix = postfix || '';                                                                                                                                                                                                                                   
				filenameParts = file.name.split('.');                                                                                                                                                                                                                      
				if (filenameParts.length > 1) {                                                                                                                                                                                                                            
					filenameParts[filenameParts.length - 2] += postfix;                                                                                                                                                                                                       
				} else if (filenameParts.length === 1) {                                                                                                                                                                                                                   
					filenameParts[0] += postfix;                                                                                                                                                                                                                              
				}                                                                                                                                                                                                                                                          
				return filenameParts.join('.');                                                                                                                                                                                                                            
			}                                                                                                                                                                                                                                                           
			return '';                                                                                                                                                                                                                                                  
		},                                                                                                                                                                                                                                                           
		getCurrentFiles: function (source) {                                                                                                                                                                                                                         
			var that = this;                                                                                                                                                                                                                                            
			var filedelay = 500;                                                                                                                                                                                                                                        
			///file handler                                                                                                                                                                                                                                             
			var files = [];                                                                                                                                                                                                                                             
			// Get any files inside file input elements or text input elements for drawings.                                                                                                                                                                            
			$('form.or').find('input[type="file"]:not(.ignore), input[type="text"][data-drawing="true"]').each(function () {                                                                                                                                            
				var newFilename;                                                                                                                                                                                                                                           
				var file = null;                                                                                                                                                                                                                                           
				var canvas = null;                                                                                                                                                                                                                                         
				if (this.type === 'file') {                                                                                                                                                                                                                                
					file = this.files[0]; // Why doesn't this fail for empty file inputs?                                                                                                                                                                                     
				} else if (this.value) {                                                                                                                                                                                                                                   
					canvas = $(this).closest('.question')[0].querySelector('.draw-widget canvas');                                                                                                                                                                            
					if (canvas) {                                                                                                                                                                                                                                             
						// TODO: In the future, we could simply do canvas.toBlob() instead                                                                                                                                                                                       
						file = that.dataUriToBlobSync(canvas.toDataURL());                                                                                                                                                                                                       
						file.name = this.value;                                                                                                                                                                                                                                  
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
				if (file && file.name) {                                                                                                                                                                                                                                   
					// Correct file names by adding a unique-ish postfix                                                                                                                                                                                                      
					// First create a clone, because the name property is immutable                                                                                                                                                                                           
					// TODO: in the future, when browser support increase we can invoke                                                                                                                                                                                       
					// the File constructor to do this.                                                                                                                                                                                                                       
					newFilename = that.getFilename(file, this.dataset.filenamePostfix);                                                                                                                                                                                       
					file = new Blob([file], {                                                                                                                                                                                                                                 
						type: file.type                                                                                                                                                                                                                                          
					});                                                                                                                                                                                                                                                       
					file.name = newFilename;                                                                                                                                                                                                                                  
					files.push(file);                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
			///end file handler                                                                                                                                                                                                                                         
			return files;                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		dataUriToBlobSync: function (dataURI) {                                                                                                                                                                                                                      
			var byteString;                                                                                                                                                                                                                                             
			var mimeString;                                                                                                                                                                                                                                             
			var buffer;                                                                                                                                                                                                                                                 
			var array;                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
			// convert base64 to raw binary data held in a string                                                                                                                                                                                                       
			// doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this                                                                                                                                                                      
			byteString = atob(dataURI.split(',')[1]);                                                                                                                                                                                                                   
			// separate out the mime component                                                                                                                                                                                                                          
			mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			// write the bytes of the string to an ArrayBuffer                                                                                                                                                                                                          
			buffer = new ArrayBuffer(byteString.length);                                                                                                                                                                                                                
			array = new Uint8Array(buffer);                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			for (var i = 0; i < byteString.length; i++) {                                                                                                                                                                                                               
				array[i] = byteString.charCodeAt(i);                                                                                                                                                                                                                       
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			// write the ArrayBuffer to a blob                                                                                                                                                                                                                          
			return new Blob([array], {                                                                                                                                                                                                                                  
				type: mimeString                                                                                                                                                                                                                                           
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		urlToBlob: function (url) {                                                                                                                                                                                                                                  
			const xhr = new XMLHttpRequest();                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			return new Promise(resolve => {                                                                                                                                                                                                                             
				xhr.open('GET', url);                                                                                                                                                                                                                                      
				xhr.responseType = 'blob';                                                                                                                                                                                                                                 
				xhr.onload = () => {                                                                                                                                                                                                                                       
					resolve(xhr.response);                                                                                                                                                                                                                                    
				};                                                                                                                                                                                                                                                         
				xhr.send();                                                                                                                                                                                                                                                
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// initialize the form                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
		_initializeForm: function () {                                                                                                                                                                                                                               
			try {                                                                                                                                                                                                                                                       
				var form = new Form('form.or:eq(0)', {                                                                                                                                                                                                                     
					modelStr: this.getModelStr(),                                                                                                                                                                                                                             
					instanceStr: this.getFormRecord(),                                                                                                                                                                                                                        
					submitted: true                                                                                                                                                                                                                                           
				}, {                                                                                                                                                                                                                                                       
					arcGis: {                                                                                                                                                                                                                                                 
						basemaps: ['streets', 'topo', 'satellite', 'osm'],                                                                                                                                                                                                       
						webMapId: 'f2e9b762544945f390ca4ac3671cfa72',                                                                                                                                                                                                            
						hasZ: true                                                                                                                                                                                                                                               
					},                                                                                                                                                                                                                                                        
					'clearIrrelevantImmediately': true                                                                                                                                                                                                                        
				});                                                                                                                                                                                                                                                        
				//initialize form and check for load errors                                                                                                                                                                                                                
				var loadErrors = form.init();                                                                                                                                                                                                                              
				if (loadErrors.length > 0) {}                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
				////******************************Start Edit scenario changes*****************                                                                                                                                                                             
				/// validate form and get model&media files string back                                                                                                                                                                                                    
				var that = this;                                                                                                                                                                                                                                           
				$('#validate-form').on('click', function () {                                                                                                                                                                                                              
					// validate form                                                                                                                                                                                                                                          
					form.validate()                                                                                                                                                                                                                                           
						.then(function (valid) {                                                                                                                                                                                                                                 
							if (!valid) {                                                                                                                                                                                                                                           
								window.alert('Form contains errors. Please see fields marked in red.');                                                                                                                                                                                
							} else {                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
								$('form.or').trigger('beforesave');                                                                                                                                                                                                                    
								that.fireEvent("enketoFormSubmit", {                                                                                                                                                                                                                   
									formRecord: form.getDataStr(),                                                                                                                                                                                                                        
									isDraft: null,                                                                                                                                                                                                                                        
									files: that.getCurrentFiles()                                                                                                                                                                                                                         
								});                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
							}                                                                                                                                                                                                                                                       
						});                                                                                                                                                                                                                                                      
				});                                                                                                                                                                                                                                                        
				$('#save-as-draft').on('click', function () {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
					$('form.or').trigger('beforesave');                                                                                                                                                                                                                       
					that.fireEvent("enketoFormSubmit", {                                                                                                                                                                                                                      
						formRecord: form.getDataStr(),                                                                                                                                                                                                                           
						isDraft: "X",                                                                                                                                                                                                                                            
						files: that.getCurrentFiles()                                                                                                                                                                                                                            
					});                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				///end validate form and get model string back                                                                                                                                                                                                             
				////////////////end Edit scenario changes////////////////	                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			} catch (err) {                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
				err.message = "errors occured in rendering the given FormHTML and Model";                                                                                                                                                                                  
				alert(err.message); //&nbsp;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		setValue: function (iValue) {                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_onSubmit: function (oEvent) {                                                                                                                                                                                                                               
			var oResourceBundle = this.getModel("i18n").getResourceBundle();                                                                                                                                                                                            
			this.fireEvent("enketoFormSubmit", {                                                                                                                                                                                                                        
				formRecord: this.getFormRecord()                                                                                                                                                                                                                           
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
	});                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
	return EnketoFormControl;                                                                                                                                                                                                                                     
});                                                                                                                                                                                                                                                            