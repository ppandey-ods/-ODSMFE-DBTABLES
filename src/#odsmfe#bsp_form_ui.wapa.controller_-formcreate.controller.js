sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/services/UserInfo","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/format/DateFormat","sap/ui/Device","odsmfe/FormUI/model/formatter","odsmfe/FormUI/lib/js/dom+
toimage","odsmfe/FormUI/lib/js/printThis","sap/ui/core/UIComponent","sap/m/MessagePopover","sap/m/MessageItem","sap/m/MessageToast","sap/m/Link","sap/ui/model/json/JSONModel"],function(e,t,r,o,a,n,s,l,d,c,u,m,g,h,f,p){return e.extend("odsmfe.FormUI.contr+
oller.FormCreate",{delay:555,oResourceBundle:null,formatter:l,FormData:null,_ReadObj:null,_localFormInstanceID:null,_mode:null,_FormInstanceID:null,_sWorkOrderNumber:null,_sOrderType:null,_sFormID:null,_sVersion:null,_sFormCreatePath:null,_FormMetaDataVe+
rsion:null,_FormMetaDataID:null,_oAttachments:null,_oDialog:null,filecontent:null,_dateFormat:n.getDateInstance({pattern:"dd/MM/YYYY hh:mm"}),onInit:function(){var e=u.getRouterFor(this);this.oRouter=e;e.getRoute("TargetFormCreate").attachMatched(this.__+
onRouteMatched,this);var t=this;this.mGroupFunctions={CreatedAt:function(e){var r=e.getProperty("CreatedAt");var o=t._dateFormat.format(r);return{key:o,text:o}}}},__onRouteMatched:function(e){var t=$("#__xmlview0--idAppControl-endColumnNav");console.log(+
t[0].childNodes);var r=t[0].children.namedItem("__xmlview3");if(r){t[0].children.namedItem("__xmlview3").remove()}var o=this;this._sWorkOrderNumber=e.getParameter("arguments").WorkOrder;var a=e.getParameter("arguments").FormMetaDataID;var n=e.getParamete+
r("arguments").Version;this._mode=e.getParameter("arguments").Mode;o._FormMetaDataID=a;o._FormMetaDataVersion=n;var i=" ";var s=this.getView().getModel("app");s.setProperty("/selectedWorkOrder",this._sWorkOrderNumber);this._sOrderType=s.getProperty("/sel+
ectedOrderType");if(this._mode===null||typeof this._mode==="undefined"){var l=s.getProperty("/selectedMode");this._mode=l}else{var l=s.getProperty("/selectedMode");if(!l||l!=this._mode){s.setProperty("/selectedMode",this._mode)}}this._sFormCreatePath="/F+
ormMetaDataSet(InstanceId='"+i+"',"+"FormId='"+a+"',"+"Version='"+n+"')";try{this.getView().bindElement({path:"/FormMetaDataSet(InstanceId='"+i+"',"+"FormId='"+a+"',"+"Version='"+n+"')",events:{dataRequested:function(){o.getView().setBusy(true)},dataRece+
ived:function(e){o.getView().setBusy(false)}}})}catch(e){console.log(e);alert("Form Render details are not provided")}},returnFormAttachments:function(e){var t=this;return new Promise(function(t,a){var n=this.getView().getModel();var i=[];i.push(new r("I+
nstanceId",o.EQ,e));n.read("/FormAttachmentSet",{filters:i,success:function(e){t(e)},error:function(e,t){a(e);console.log("Attachments record not found .")}})}.bind(this))},readResponseCaptureSet:function(e){var t=this;return new Promise(function(e,t){va+
r r=this.getView().getModel();var o="/ResponseCaptureSet('"+this._FormInstanceID+"')";r.read(o,{success:function(t){e(t);console.log("response record fetched")},error:function(e,r){t(e);console.log("response record not found .Error while fetching record +
- ")}})}.bind(this))},getEditForm:function(e){var t=new sap.m.BusyDialog;t.open();var r=function(e){var t=-1,r=e.length;var o=function(){t++;if(t==r){e.callbackform();return}e.functionToLoopForm(o,t)};o()};r({length:e.length,functionToLoopForm:function(r+
,o){try{var a=o;var n=e[o].FileName;var i=e[o].ImageData;$(".with-media").each(function(e,t){var r="";for(var o=0;o<t.childNodes.length;o++){var a=t.childNodes[o];if(t.childNodes[o].accept==undefined){}else{if(t.childNodes[o].accept.slice(0,-2)=="image"&+
&t.childNodes[o].outerHTML.includes(n)){r="image";t.childNodes[o+1].childNodes[7].outerHTML='<div class="file-preview"><img src="data:image/png;base64,'+i+'"</img>';var s=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(s){s.item(0)+
.hidden=true}var l=t.childNodes[o+1].getElementsByClassName("file-feedback error");if(l){l.item(0).hidden=true}}else if(t.childNodes[o].accept.slice(0,-2)=="audio"&&t.childNodes[o].outerHTML.includes(n)){t.childNodes[o+1].childNodes[7].outerHTML='<div cl+
ass="file-preview"><audio controls type="audio/mpeg" src="data:audio/ogg;base64,'+i+'"</audio>';var s=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(s){s.item(0).hidden=true}var l=t.childNodes[o+1].getElementsByClassName("file-fee+
dback error");if(l){l.item(0).hidden=true}}else if(t.childNodes[o].accept.slice(0,-2)=="video"&&t.childNodes[o].outerHTML.includes(n)){t.childNodes[o+1].childNodes[7].outerHTML='<div class="file-preview"><video controls type="video/mp4" src="data:video/m+
p4;base64,'+i+'"</video>';var s=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(s){s.item(0).hidden=true}var l=t.childNodes[o+1].getElementsByClassName("file-feedback error");if(l){l.item(0).hidden=true}}}}});$(".or-appearance-sign+
ature").each(function(e,t){var r="";for(var o=0;o<t.childNodes.length;o++){var a=t.childNodes[o];if(t.childNodes[o].accept==undefined){}else{if(t.childNodes[o].accept.slice(0,-2)=="image"&&t.childNodes[o].outerHTML.includes(n)){r="image";var s=t.childNod+
es[o+1].getElementsByClassName("draw-widget__body");if(s){s.item(0).hidden=true}var l='<div class="file-preview"><img src="data:image/png;base64,'+i+'"</img></div>';$(".draw-widget__footer").append(l);var d=t.childNodes[o+1].getElementsByClassName("btn-i+
con-only btn-reset");if(d){d.item(0).hidden=true}var c=t.childNodes[o+1].getElementsByClassName("draw-widget__feedback");if(c){c.item(0).hidden=true}}}}})}catch(e){console.log(e);t.close()}setTimeout(function(){r()},2e3)},callbackform:function(){console.+
log("All done!");t.close()}})},getfileContent:function(e){var t=this;const r=new FileReader;return new Promise((o,a)=>{r.onerror=(()=>{r.abort();a(new DOMException("Problem parsing input file."))});r.onload=(()=>{var a=[];var n=r.result.split(",");a.push+
({file:e,data:n[1]});o(a);t.filecontent=r.result;return r.result});r.readAsDataURL(e)})},onEnketoFormSubmit:function(e){var t=this;try{var r=new sap.m.BusyDialog;r.setText("Please wait ..form is getting saved and loading attachments");r.open();var o=e.ge+
tParameter("formRecord");var a=e.getParameter("isDraft");var n=e.getParameter("files");var i=$(o).find("instanceID").text().split(":")[1];t._FormInstanceID=i;var s=$(o).find("deprecatedID").text().split(":")[0];var l=$(o).find("deprecatedID").text().spli+
t(":")[1];var d=o.replace("<deprecatedID>uuid:","");var d=d.replace(l,"");var d=d.replace("</deprecatedID>","");t.FormData=d;var c=t.ascii_to_hex(t.FormData);var u=this.getView().getModel();u.setHeaders({"X-Requested-With":"X"});var m={InstanceID:t._Form+
InstanceID,FormID:t._FormMetaDataID,Version:t._FormMetaDataVersion,WoNum:t._sWorkOrderNumber,OperationNum:"",Equipment:"",FunctionLocation:"",ResponseData:c,CreatedOn:new Date,IsDraft:a,NonObjType:"",OrderType:t._sOrderType};var g="/ResponseCaptureSet";u+
.create(g,m,{success:function(e,o){var a=document.getElementById("EnketoFormControl");footer="<div ></div>";$("#EnketoFormSubmit").html(footer);a.classList.toggle("lock");var n=t.getView().byId("__xmlview4--btn_saveasdraft");var i=t.getView().byId("__xml+
view4--btn_submit");if(n){n.setVisible(false)}if(i){i.setVisible(false)}console.log("Response created Successfully");h.show("Response created Successfully",{duration:3e3,width:"30em"});r.close()},error:function(e,t){console.log("Response not created .Err+
or while updating record");h.show("Response not created .Error while updating record",{duration:3e3,width:"30em"})}});for(var f=0;f<n.length;f++){var p=t.getfileContent(n[f]);p.then(function(e){var r=e[0].data;var o={InstanceId:t._FormInstanceID,FormId:t+
._FormMetaDataID,Version:t._FormMetaDataVersion,AttachCounter:"0000"+Math.floor(1e3+Math.random()*9e3),FileName:e[0].file.name,MimeType:e[0].file.type,ObjectNum:t._sWorkOrderNumber,ImageData:r,CreatedOn:new Date};console.log(o);var a="/FormAttachmentSet"+
;u.create(a,o,{success:function(e,t){console.log("Attachement Record Updated Successfully")},error:function(e,t){console.log("Attachment record not updated .Error while updating record")}})})}this.oResourceBundle=this.getView().getModel("i18n").getResour+
ceBundle();var v=this.oResourceBundle.getText("AttachBusyMsgLong");var y=new sap.m.BusyDialog;y.setText(v);y.open();setTimeout(function(){var e=t.returnFormAttachments(t._FormInstanceID);e.then(function(e){var r=e.results;t.getEditForm(r);y.close()}.bind+
(this)).catch(function(e){console.log("Attachments record not found .");y.close()}.bind(this))},15e3)}catch(e){alert("Error in Saving updated Form");r.close()}},onSaveAsDraftPress:function(e){$("#save-as-draft").trigger("click")},onSubmitPress:function(e+
){$("#validate-form").trigger("click")},onExpand:function(e){var t=document.getElementsByClassName("or-appearance-compact");var r=t.length;for(i=r;i>=0;i--){var o=t[i];if(o){o.classList.remove("or-appearance-compact")}}},onCollapse:function(e){var t=docu+
ment.getElementsByClassName("or-group");var r=t.length;for(i=r;i>=0;i--){var o=t[i];if(o){o.classList.add("or-appearance-compact")}}},onPrint:function(e,t){this.oResourceBundle=this.getView().getModel("i18n").getResourceBundle();if(!t){t=this.oResourceBu+
ndle.getText("PrintBusyMsgLong")}var r=this;var o=document.getElementsByClassName("or-appearance-compact");var a=o.length;if(a){alert(this.oResourceBundle.getText("PrintAlertMsgLong"));for(i=a;i>=0;i--){var n=o[i];if(n){n.classList.remove("or-appearance-+
compact")}}}setTimeout(function(){var e=new sap.m.BusyDialog;e.setText(t);e.open();var r=window.location.pathname;var o=r.search("ui5_ui5");if(o>="0"){var a=window.location.origin+"/sap/bc/ui5_ui5/odsmfe/bsp_form_ui/lib/css/grid.css"}else if(r.search("we+
bapp/")>="0"){var a=window.location.origin+"/webapp/lib/css/grid.css"}$("#EnketoFormBody").printThis({debug:false,importCSS:true,importStyle:false,printContainer:true,loadCSS:a,pageTitle:"",removeInline:false,removeInlineSelector:"*",printDelay:4e3,heade+
r:null,footer:null,base:false,formValues:true,canvas:true,doctypeString:"",removeScripts:false,copyTagClasses:false,beforePrintEvent:null,beforePrint:null,afterPrint:function(){e.close()}})},r.delay)},onPDFPress:function(){this.oResourceBundle=this.getVi+
ew().getModel("i18n").getResourceBundle();try{var e=this;var t=document.getElementsByClassName("or-appearance-compact");var r=t.length;if(r){alert(this.oResourceBundle.getText("PDFAlertMsgLong"));for(i=r;i>=0;i--){var o=t[i];if(o){o.classList.remove("or-+
appearance-compact")}}}var a=$("#EnketoFormBody")[0];if(a.clientHeight>13e3){var n=this.oResourceBundle.getText("PrintBusyMsgShort");this.onPrint("",n)}else{var s=new sap.m.BusyDialog;s.setText(this.oResourceBundle.getText("PDFBusyMsgShort"));s.open();va+
r e=this;var a=$("#EnketoFormBody")[0];var l=new jsPDF("p","mm");var d=e._sWorkOrderNumber+"_"+e._FormMetaDataID+"_"+e._FormMetaDataVersion+".pdf";var c={background:"white",height:a.clientHeight,width:1350};domtoimage.toPng(a,c).then(e=>{var t=l.internal+
.pageSize.height;var r=l.internal.pageSize.width;var o=a.clientHeight*25.4/96;var n=Math.ceil(o/t);l.addImage(e,"PNG",2,0,r-1,0);if(n>0){var i=1;while(i!=n){l.addPage("l","mm","a3");l.addImage(e,"PNG",2,-(i*t),r-1,0);i++}}s.close();l.save(d)}).catch(func+
tion(t){s.close();var r=e.oResourceBundle.getText("PrintBusyMsgShort");e.onPrint("",r)})}}catch(e){alert(e.message)}},_hex_to_ascii:function(e){if(e===undefined||e==null||e.length<=0){return""}var t=e.toString();var r="";for(var o=0;o<t.length;o+=2){r+=S+
tring.fromCharCode(parseInt(t.substr(o,2),16))}return r},ascii_to_hex:function(e){var t,r;var o="";for(r=0;r<e.length;r++){t=e.charCodeAt(r).toString(16);o+=("0"+t).slice(-2)}return o},onCloseDetailPress:function(){var e=this.getView().getModel("app");e.+
setProperty("/actionButtonsInfo/endColumn/fullScreen",false);this.getOwnerComponent().getRouter().navTo("TargetWorkOrderFormList",{WorkOrderNumber:this._sWorkOrderNumber},true)},toggleFullScreen:function(){var e=this.getView().getModel("app");var t=e.get+
Property("/actionButtonsInfo/endColumn/fullScreen");e.setProperty("/actionButtonsInfo/endColumn/fullScreen",!t);if(!t){e.setProperty("/previousLayout",e.getProperty("/layout"));e.setProperty("/layout","EndColumnFullScreen")}else{e.setProperty("/layout",e+
.getProperty("/previousLayout"))}}})});                                                                                                                                                                                                                        