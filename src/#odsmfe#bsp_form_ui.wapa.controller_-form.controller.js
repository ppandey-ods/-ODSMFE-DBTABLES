sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/services/UserInfo","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/format/DateFormat","sap/ui/Device","odsmfe/FormUI/model/formatter","odsmfe/FormUI/lib/js/dom+
toimage","odsmfe/FormUI/lib/js/printThis","sap/ui/core/UIComponent","sap/m/MessagePopover","sap/m/MessageItem","sap/m/MessageToast","sap/m/Link","sap/ui/model/json/JSONModel"],function(e,t,r,o,a,s,n,l,c,d,u,m,h,g,f,p){return e.extend("odsmfe.FormUI.contr+
oller.Form",{delay:555,oResourceBundle:null,formatter:l,FormData:null,_icount:0,_ReadObj:null,_localFormInstanceID:null,_mode:null,_FormInstanceID:null,_sWorkOrderNumber:null,_sFormID:null,_sVersion:null,_sFormPath:null,_FormMetaDataVersion:null,_FormMet+
aDataID:null,_oAttachments:null,_oDialog:null,filecontent:null,_dateFormat:s.getDateInstance({pattern:"dd/MM/YYYY hh:mm"}),onInit:function(){var e=u.getRouterFor(this);this.oRouter=e;e.getRoute("TargetForm").attachMatched(this.__onRouteMatched,this);var +
t=this;this.mGroupFunctions={CreatedAt:function(e){var r=e.getProperty("CreatedAt");var o=t._dateFormat.format(r);return{key:o,text:o}}}},__onRouteMatched:function(e){var t=$("#__xmlview0--idAppControl-endColumnNav");console.log(t[0].childNodes);if(t[0].+
childNodes.length>1){t[0].childNodes[0].remove()}if(t[0].childNodes[0].outerText.includes("Create")){t[0].childNodes[0].remove()}console.log(t[0].childNodes);var r=this;var o=e.getParameter("arguments").FormInstanceID;this._mode=e.getParameter("arguments+
").Mode;this._localFormInstanceID=o;this._FormInstanceID=encodeURIComponent(o);var a=this.getView().getModel("app");if(this._mode===null||typeof this._mode==="undefined"){var a=this.getView().getModel("app");var s=a.getProperty("/selectedMode");this._mod+
e=s}else{var a=this.getView().getModel("app");var s=a.getProperty("/selectedMode");if(!s||s!=this._mode){a.setProperty("/selectedMode",this._mode)}}this._sFormPath="/ResponseCaptureSet('"+this._FormInstanceID+"')";this.getView().bindElement({path:"/Respo+
nseCaptureSet('"+this._FormInstanceID+"')",parameters:{expand:"FormMetaData"},events:{dataRequested:function(){r.getView().setBusy(true)},dataReceived:function(e){var t=r.getView().getModel();r._sFormID=t.getProperty(r._sFormPath+"/FormID");r._sWorkOrder+
Number=t.getProperty(r._sFormPath+"/WoNum");r._sVersion=t.getProperty(r._sFormPath+"/Version");r.getView().setBusy(false)}}});var i=this.getView().byId("__xmlview3--btn_saveasdraft");var n=this.getView().byId("__xmlview3--btn_submit");if(this._mode=="Dis+
play"){if(i){i.setVisible(false)}if(n){n.setVisible(false)}}else if(this._mode=="Edit"){if(i){i.setVisible(true)}if(n){n.setVisible(true)}}else if(this._mode=="Create"){if(i){i.setVisible(true)}if(n){n.setVisible(true)}}this.oResourceBundle=this.getView(+
).getModel("i18n").getResourceBundle();var l=this.oResourceBundle.getText("AttachBusyMsgLong");var c=new sap.m.BusyDialog;c.setText(l);c.open();setTimeout(function(){var e=r.returnFormAttachments(r._FormInstanceID);e.then(function(e){var t=e.results;r.ge+
tEditForm(t);c.close()}.bind(this)).catch(function(e){console.log("Attachments record not found .");c.close()}.bind(this))},4e3)},returnFormAttachments:function(e){var t=this;return new Promise(function(t,a){var s=this.getView().getModel();var i=[];i.pus+
h(new r("InstanceId",o.EQ,e));s.read("/FormAttachmentSet",{filters:i,success:function(e){t(e)},error:function(e,t){a(e);console.log("Attachments record not found .")}})}.bind(this))},readResponseCaptureSet:function(e){var t=this;return new Promise(functi+
on(e,t){var r=this.getView().getModel();var o="/ResponseCaptureSet('"+this._FormInstanceID+"')";r.read(o,{success:function(t){e(t);console.log("response record fetched")},error:function(e,r){t(e);console.log("response record not found .Error while fetchi+
ng record - ")}})}.bind(this))},getEditForm:function(e){var t=new sap.m.BusyDialog;t.open();var r=function(e){var t=-1,r=e.length;var o=function(){t++;if(t==r){e.callbackform();return}e.functionToLoopForm(o,t)};o()};r({length:e.length,functionToLoopForm:+
function(r,o){try{var a=o;var s=e[o].FileName;var i=e[o].ImageData;$(".with-media").each(function(e,t){var r="";for(var o=0;o<t.childNodes.length;o++){var a=t.childNodes[o];if(t.childNodes[o].accept==undefined){}else{if(t.childNodes[o].accept.slice(0,-2)+
=="image"&&t.childNodes[o].outerHTML.includes(s)){r="image";t.childNodes[o+1].childNodes[7].outerHTML='<div class="file-preview"><img src="data:image/png;base64,'+i+'"</img>';var n=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(n)+
{n.item(0).hidden=true}var l=t.childNodes[o+1].getElementsByClassName("file-feedback error");if(l){l.item(0).hidden=true}}else if(t.childNodes[o].accept.slice(0,-2)=="audio"&&t.childNodes[o].outerHTML.includes(s)){t.childNodes[o+1].childNodes[7].outerHTM+
L='<div class="file-preview"><audio controls type="audio/mpeg" src="data:audio/ogg;base64,'+i+'"</audio>';var n=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(n){n.item(0).hidden=true}var l=t.childNodes[o+1].getElementsByClassName+
("file-feedback error");if(l){l.item(0).hidden=true}}else if(t.childNodes[o].accept.slice(0,-2)=="video"&&t.childNodes[o].outerHTML.includes(s)){t.childNodes[o+1].childNodes[7].outerHTML='<div class="file-preview"><video controls type="video/mp4" src="da+
ta:video/mp4;base64,'+i+'"</video>';var n=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(n){n.item(0).hidden=true}var l=t.childNodes[o+1].getElementsByClassName("file-feedback error");if(l){l.item(0).hidden=true}}}}});$(".or-appea+
rance-signature").each(function(e,t){var r="";for(var o=0;o<t.childNodes.length;o++){var a=t.childNodes[o];if(t.childNodes[o].accept==undefined){}else{if(t.childNodes[o].accept.slice(0,-2)=="image"&&t.childNodes[o].outerHTML.includes(s)){r="image";var n=+
t.childNodes[o+1].getElementsByClassName("draw-widget__body");var l='<div class="file-preview"><img src="data:image/png;base64,'+i+'"</img></div>';n[0].innerHTML=l;var c=t.childNodes[o+1].getElementsByClassName("btn-icon-only btn-reset");if(c){c.item(0).+
hidden=true}var d=t.childNodes[o+1].getElementsByClassName("draw-widget__feedback");if(d){d.item(0).hidden=true}}}}})}catch(e){console.log(e);t.close()}setTimeout(function(){r()},2e3)},callbackform:function(){console.log("All done!");t.close()}})},getfil+
eContent:function(e){var t=this;const r=new FileReader;return new Promise((o,a)=>{r.onerror=(()=>{r.abort();a(new DOMException("Problem parsing input file."))});r.onload=(()=>{var a=[];var s=r.result.split(",");a.push({file:e,data:s[1]});o(a);t.fileconte+
nt=r.result;return r.result});r.readAsDataURL(e)})},onEnketoFormSubmit:function(e){var t=this;try{var r=new sap.m.BusyDialog;r.setText("Please wait ..form is getting saved and loading attachments");r.open();var o=e.getParameter("formRecord");var a=e.getP+
arameter("isDraft");var s=e.getParameter("files");var i=$(o).find("deprecatedID").text().split(":")[0];var n=$(o).find("deprecatedID").text().split(":")[1];var l=o.replace("<deprecatedID>uuid:","");var l=l.replace(n,"");var l=l.replace("</deprecatedID>",+
"");t.FormData=l;var c=t.ascii_to_hex(t.FormData);var d=this.getView().getModel();d.setHeaders({"X-Requested-With":"X"});var u="/ResponseCaptureSet('"+this._FormInstanceID+"')";var m=this.readResponseCaptureSet(this._FormInstanceID);m.then(function(e){t.+
_ReadObj=e;t._ReadObj.ResponseData=c;t._ReadObj.ModifiedOn=new Date;t._ReadObj.IsDraft=a;var o="/ResponseCaptureSet('"+t._FormInstanceID+"')";d.update(o,t._ReadObj,{success:function(e,t){alert("Response Updated Successfully");r.close()},error:function(e,+
t){alert("Response not updated .Error while updating record")}});for(var i=0;i<s.length;i++){var n=t.getfileContent(s[i]);n.then(function(e){var r=e[0].data;var o={InstanceId:t._FormInstanceID,FormId:t._sFormID,Version:t._sVersion,AttachCounter:"0000"+Ma+
th.floor(1e3+Math.random()*9e3),FileName:e[0].file.name,MimeType:e[0].file.type,ObjectNum:t._sWorkOrderNumber,ImageData:r,CreatedOn:new Date};console.log(o);var a="/FormAttachmentSet";d.create(a,o,{success:function(e,t){console.log("Attachement Record Up+
dated Successfully")},error:function(e,t){console.log("Attachment record not updated .Error while updating record")}})})}}.bind(this));this.oResourceBundle=this.getView().getModel("i18n").getResourceBundle();var h=this.oResourceBundle.getText("AttachBusy+
MsgLong");var g=new sap.m.BusyDialog;g.setText(h);g.open();setTimeout(function(){var e=t.returnFormAttachments(t._FormInstanceID);e.then(function(e){var r=e.results;t.getEditForm(r);g.close()}.bind(this)).catch(function(e){console.log("Attachments record+
 not found .");g.close()}.bind(this))},15e3)}catch(e){alert("Error in Saving updated Form");r.close()}},onSaveAsDraftPress:function(e){$("#save-as-draft").trigger("click")},onSubmitPress:function(e){$("#validate-form").trigger("click")},onExpand:function+
(e){var t=document.getElementsByClassName("or-appearance-compact");var r=t.length;for(i=r;i>=0;i--){var o=t[i];if(o){o.classList.remove("or-appearance-compact")}}},onCollapse:function(e){var t=document.getElementsByClassName("or-group");var r=t.length;fo+
r(i=r;i>=0;i--){var o=t[i];if(o){o.classList.add("or-appearance-compact")}}},onPrint:function(e,t){this.oResourceBundle=this.getView().getModel("i18n").getResourceBundle();if(!t){t=this.oResourceBundle.getText("PrintBusyMsgLong")}var r=this;var o=documen+
t.getElementsByClassName("or-appearance-compact");var a=o.length;if(a){alert(this.oResourceBundle.getText("PrintAlertMsgLong"));for(i=a;i>=0;i--){var s=o[i];if(s){s.classList.remove("or-appearance-compact")}}}setTimeout(function(){var e=new sap.m.BusyDia+
log;e.setText(t);e.open();var r=window.location.pathname;var o=r.search("ui5_ui5");if(o>="0"){var a=window.location.origin+"/sap/bc/ui5_ui5/odsmfe/bsp_form_ui/lib/css/grid.css"}else if(r.search("webapp/")>="0"){var a=window.location.origin+"/webapp/lib/c+
ss/grid.css"}$("#EnketoFormBody").printThis({debug:false,importCSS:true,importStyle:false,printContainer:true,loadCSS:a,pageTitle:"",removeInline:false,removeInlineSelector:"*",printDelay:4e3,header:null,footer:null,base:false,formValues:true,canvas:true+
,doctypeString:"",removeScripts:false,copyTagClasses:false,beforePrintEvent:null,beforePrint:null,afterPrint:function(){e.close()}})},r.delay)},onPDFPress:function(){this.oResourceBundle=this.getView().getModel("i18n").getResourceBundle();try{var e=this;+
var t=document.getElementsByClassName("or-appearance-compact");var r=t.length;if(r){alert(this.oResourceBundle.getText("PDFAlertMsgLong"));for(i=r;i>=0;i--){var o=t[i];if(o){o.classList.remove("or-appearance-compact")}}}var a=$("#EnketoFormBody")[0];if(a+
.clientHeight>13e3){var s=this.oResourceBundle.getText("PrintBusyMsgShort");this.onPrint("",s)}else{var n=new sap.m.BusyDialog;n.setText(this.oResourceBundle.getText("PDFBusyMsgShort"));n.open();var e=this;var a=$("#EnketoFormBody")[0];var l=new jsPDF("p+
","mm");var c=this.getView().getModel();var d=c.getProperty(this._sFormPath+"/FormID");var u=c.getProperty(this._sFormPath+"/WoNum");var m=c.getProperty(this._sFormPath+"/Version");var h=u+"_"+d+"_"+m+".pdf";var g={background:"white",height:a.clientHeigh+
t,width:1300};domtoimage.toPng(a,g).then(e=>{var t=l.internal.pageSize.height;var r=l.internal.pageSize.width;var o=a.clientHeight*25.4/96;var s=Math.ceil(o/t);l.addImage(e,"PNG",2,0,r-1,0);if(s>0){var i=1;while(i!=s){l.addPage("l","mm","a3");l.addImage(+
e,"PNG",2,-(i*t),r-1,0);i++}}n.close();l.save(h)}).catch(function(t){n.close();var r=e.oResourceBundle.getText("PrintBusyMsgShort");e.onPrint("",r)})}}catch(e){alert(e.message)}},_hex_to_ascii:function(e){if(e===undefined||e==null||e.length<=0){return""}+
var t=e.toString();var r="";for(var o=0;o<t.length;o+=2){r+=String.fromCharCode(parseInt(t.substr(o,2),16))}return r},ascii_to_hex:function(e){var t,r;var o="";for(r=0;r<e.length;r++){t=e.charCodeAt(r).toString(16);o+=("0"+t).slice(-2)}return o},onCloseD+
etailPress:function(){var e=this.getView().getModel("app");e.setProperty("/actionButtonsInfo/endColumn/fullScreen",false);var t=this.getView().getModel();this._sWorkOrderNumber=t.getProperty(this._sFormPath+"/WoNum");this.getOwnerComponent().getRouter().+
navTo("TargetWorkOrderFormList",{WorkOrderNumber:this._sWorkOrderNumber},true)},toggleFullScreen:function(){var e=this.getView().getModel("app");var t=e.getProperty("/actionButtonsInfo/endColumn/fullScreen");e.setProperty("/actionButtonsInfo/endColumn/fu+
llScreen",!t);if(!t){e.setProperty("/previousLayout",e.getProperty("/layout"));e.setProperty("/layout","EndColumnFullScreen")}else{e.setProperty("/layout",e.getProperty("/previousLayout"))}}})});                                                            