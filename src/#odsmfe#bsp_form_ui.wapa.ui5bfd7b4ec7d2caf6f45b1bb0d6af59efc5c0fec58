sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"sap/ushell/services/UserInfo",                                                                                                                                                                                                                               
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
	"sap/ui/model/Sorter",                                                                                                                                                                                                                                        
	"sap/ui/core/format/DateFormat",                                                                                                                                                                                                                              
	"sap/ui/Device",                                                                                                                                                                                                                                              
	"odsmfe/FormUI/model/formatter",                                                                                                                                                                                                                              
	"odsmfe/FormUI/lib/js/domtoimage",                                                                                                                                                                                                                            
	"odsmfe/FormUI/lib/js/printThis",                                                                                                                                                                                                                             
	"sap/ui/core/UIComponent",                                                                                                                                                                                                                                    
	'sap/m/MessagePopover',                                                                                                                                                                                                                                       
	'sap/m/MessageItem',                                                                                                                                                                                                                                          
	'sap/m/MessageToast',                                                                                                                                                                                                                                         
	'sap/m/Link',                                                                                                                                                                                                                                                 
	'sap/ui/model/json/JSONModel'                                                                                                                                                                                                                                 
], function (Controller, ushellContainer, Filter, FilterOperator, Sorter, DateFormat, Device, formatter, domtoimagejs, printThisjs,                                                                                                                            
	UIComponent, MessagePopover, MessageItem, MessageToast, Link, JSONModel) {                                                                                                                                                                                    
	//	"use strict";                                                                                                                                                                                                                                              
	// var oMessagePopover;                                                                                                                                                                                                                                       
	return Controller.extend("odsmfe.FormUI.controller.FormCreate", {                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// VARIABLES                                                                                                                                                                                                                                                 
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		delay: 555,                                                                                                                                                                                                                                                  
		oResourceBundle: null,                                                                                                                                                                                                                                       
		formatter: formatter,                                                                                                                                                                                                                                        
		FormData: null,                                                                                                                                                                                                                                              
		_ReadObj: null,                                                                                                                                                                                                                                              
		_localFormInstanceID: null,                                                                                                                                                                                                                                  
		_mode: null,                                                                                                                                                                                                                                                 
		_FormInstanceID: null,                                                                                                                                                                                                                                       
		_sWorkOrderNumber: null,                                                                                                                                                                                                                                     
		_sOrderType: null,                                                                                                                                                                                                                                           
		_sFormID: null,                                                                                                                                                                                                                                              
		_sVersion: null,                                                                                                                                                                                                                                             
		_sFormCreatePath: null,                                                                                                                                                                                                                                      
		_FormMetaDataVersion: null,                                                                                                                                                                                                                                  
		_FormMetaDataID: null,                                                                                                                                                                                                                                       
		_oAttachments: null,                                                                                                                                                                                                                                         
		_oDialog: null,                                                                                                                                                                                                                                              
		filecontent: null,                                                                                                                                                                                                                                           
		_dateFormat: DateFormat.getDateInstance({                                                                                                                                                                                                                    
			pattern: "dd/MM/YYYY hh:mm"                                                                                                                                                                                                                                 
		}),                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// CONTROLLER LIFECYCLE EVENTS                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		onInit: function () {                                                                                                                                                                                                                                        
			var oRouter = UIComponent.getRouterFor(this);                                                                                                                                                                                                               
			this.oRouter = oRouter;                                                                                                                                                                                                                                     
			oRouter.getRoute("TargetFormCreate").attachMatched(this.__onRouteMatched, this);                                                                                                                                                                            
                                                                                                                                                                                                                                                               
			var oController = this;                                                                                                                                                                                                                                     
			this.mGroupFunctions = {                                                                                                                                                                                                                                    
				CreatedAt: function (oContext) {                                                                                                                                                                                                                           
					var dCreatedAt = oContext.getProperty("CreatedAt");                                                                                                                                                                                                       
					var sDateFormatted = oController._dateFormat.format(dCreatedAt);                                                                                                                                                                                          
					return {                                                                                                                                                                                                                                                  
						key: sDateFormatted,                                                                                                                                                                                                                                     
						text: sDateFormatted                                                                                                                                                                                                                                     
					};                                                                                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
			};                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		__onRouteMatched: function (oEvent) {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			var parentelement = $("#__xmlview0--idAppControl-endColumnNav");                                                                                                                                                                                            
			console.log(parentelement[0].childNodes);                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
			var xmlv3 = parentelement[0].children.namedItem("__xmlview3");                                                                                                                                                                                              
			if (xmlv3) {                                                                                                                                                                                                                                                
				parentelement[0].children.namedItem("__xmlview3").remove();                                                                                                                                                                                                
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var that = this;                                                                                                                                                                                                                                            
			this._sWorkOrderNumber = oEvent.getParameter("arguments").WorkOrder;                                                                                                                                                                                        
			var metadataid = oEvent.getParameter("arguments").FormMetaDataID;                                                                                                                                                                                           
			var versionnum = oEvent.getParameter("arguments").Version;                                                                                                                                                                                                  
			this._mode = oEvent.getParameter("arguments").Mode;                                                                                                                                                                                                         
			that._FormMetaDataID = metadataid;                                                                                                                                                                                                                          
			that._FormMetaDataVersion = versionnum;                                                                                                                                                                                                                     
			var eInstanceid = " ";                                                                                                                                                                                                                                      
			var appModel = this.getView().getModel("app");                                                                                                                                                                                                              
			appModel.setProperty("/selectedWorkOrder", this._sWorkOrderNumber);                                                                                                                                                                                         
			this._sOrderType = appModel.getProperty("/selectedOrderType");                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
			if (this._mode === null || typeof (this._mode) === "undefined") {                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
				var selectedMode = appModel.getProperty("/selectedMode");                                                                                                                                                                                                  
				this._mode = selectedMode;                                                                                                                                                                                                                                 
			} else {                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				var selectedMode = appModel.getProperty("/selectedMode");                                                                                                                                                                                                  
				if (!selectedMode || (selectedMode != this._mode)) {                                                                                                                                                                                                       
					appModel.setProperty("/selectedMode", this._mode);                                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			this._sFormCreatePath = "/FormMetaDataSet(InstanceId='" + eInstanceid + "'," + "FormId='" + metadataid + "'," + "Version='" +                                                                                                                               
				versionnum + "')"                                                                                                                                                                                                                                          
			try {                                                                                                                                                                                                                                                       
				this.getView().bindElement({                                                                                                                                                                                                                               
					path: "/FormMetaDataSet(InstanceId='" + eInstanceid + "'," + "FormId='" + metadataid + "'," + "Version='" + versionnum + "')",                                                                                                                            
                                                                                                                                                                                                                                                               
					events: {                                                                                                                                                                                                                                                 
						dataRequested: function () {                                                                                                                                                                                                                             
							that.getView().setBusy(true);                                                                                                                                                                                                                           
						},                                                                                                                                                                                                                                                       
						dataReceived: function (response) {                                                                                                                                                                                                                      
							that.getView().setBusy(false);                                                                                                                                                                                                                          
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			} catch (err) {                                                                                                                                                                                                                                             
				console.log(err);                                                                                                                                                                                                                                          
				alert("Form Render details are not provided")                                                                                                                                                                                                              
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		returnFormAttachments: function (eFormInstanceID) {                                                                                                                                                                                                          
			var that = this;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
			return new Promise(function (resolve, reject) {                                                                                                                                                                                                             
				var oFormModel = this.getView().getModel();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
				var aFilters = [];                                                                                                                                                                                                                                         
				aFilters.push(new Filter("InstanceId", FilterOperator.EQ, eFormInstanceID));                                                                                                                                                                               
				oFormModel.read("/FormAttachmentSet", {                                                                                                                                                                                                                    
					filters: aFilters,                                                                                                                                                                                                                                        
					success: function (data) {                                                                                                                                                                                                                                
						resolve(data);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
					},                                                                                                                                                                                                                                                        
					error: function (err, oResponse) {                                                                                                                                                                                                                        
						reject(err);                                                                                                                                                                                                                                             
						console.log('Attachments record not found .');                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
			}.bind(this));                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		readResponseCaptureSet: function (eFormInstanceID) {                                                                                                                                                                                                         
			var that = this;                                                                                                                                                                                                                                            
			return new Promise(function (resolve, reject) {                                                                                                                                                                                                             
				var oFormModel = this.getView().getModel();                                                                                                                                                                                                                
				var serviceUrlPath = "/ResponseCaptureSet('" + this._FormInstanceID + "')";                                                                                                                                                                                
				oFormModel.read(serviceUrlPath, {                                                                                                                                                                                                                          
					success: function (data) {                                                                                                                                                                                                                                
						resolve(data);                                                                                                                                                                                                                                           
						console.log('response record fetched');                                                                                                                                                                                                                  
					},                                                                                                                                                                                                                                                        
					error: function (err, oResponse) {                                                                                                                                                                                                                        
						reject(err);                                                                                                                                                                                                                                             
						console.log('response record not found .Error while fetching record - ');                                                                                                                                                                                
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
			}.bind(this));                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		////*********************Display Form Attachments/media **********************                                                                                                                                                                               
                                                                                                                                                                                                                                                               
		getEditForm: function (array) {                                                                                                                                                                                                                              
			var oBusyIndicatorEditform = new sap.m.BusyDialog();                                                                                                                                                                                                        
			oBusyIndicatorEditform.open();                                                                                                                                                                                                                              
			///////////////////////////////////                                                                                                                                                                                                                         
			var asyncLoopForm = function (o) {                                                                                                                                                                                                                          
				var k = -1,                                                                                                                                                                                                                                                
					length = o.length;                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				var loopform = function () {                                                                                                                                                                                                                               
					k++;                                                                                                                                                                                                                                                      
					if (k == length) {                                                                                                                                                                                                                                        
						o.callbackform();                                                                                                                                                                                                                                        
						return;                                                                                                                                                                                                                                                  
					}                                                                                                                                                                                                                                                         
					o.functionToLoopForm(loopform, k);                                                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
				loopform(); //init                                                                                                                                                                                                                                         
			}                                                                                                                                                                                                                                                           
			asyncLoopForm({                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
				length: array.length, //data.results.length,                                                                                                                                                                                                               
				functionToLoopForm: function (loopform, k) {                                                                                                                                                                                                               
					try {                                                                                                                                                                                                                                                     
						var attachmentlineno = k;                                                                                                                                                                                                                                
						var filename = array[k].FileName;                                                                                                                                                                                                                        
						var mediadata = array[k].ImageData;                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
						$(".with-media").each(function (index, element) {                                                                                                                                                                                                        
							// console.log(element.childNodes)                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
							var imagetype = '';                                                                                                                                                                                                                                     
							for (var i = 0; i < element.childNodes.length; i++) {                                                                                                                                                                                                   
								var de = element.childNodes[i];                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
								if (element.childNodes[i].accept == undefined) {                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
								} else {                                                                                                                                                                                                                                               
									if (element.childNodes[i].accept.slice(0, -2) == "image" && element.childNodes[i].outerHTML.includes(filename)) {                                                                                                                                     
										imagetype = 'image';                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
										element.childNodes[i + 1].childNodes[7].outerHTML = '<div class="file-preview"><img src="data:image/png;base64,' +                                                                                                                                   
											mediadata + '"</img>';                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
										var reseticon = element.childNodes[i + 1].getElementsByClassName("btn-icon-only btn-reset");                                                                                                                                                         
										if (reseticon) {                                                                                                                                                                                                                                     
											reseticon.item(0).hidden = true;                                                                                                                                                                                                                    
										}                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
										var feedbacktext = element.childNodes[i + 1].getElementsByClassName("file-feedback error");                                                                                                                                                          
										if (feedbacktext) {                                                                                                                                                                                                                                  
											feedbacktext.item(0).hidden = true;                                                                                                                                                                                                                 
										}                                                                                                                                                                                                                                                    
										//element.childNodes[i].lastChild.outerHTML='<div class="file-preview"><img src="'+def+'"</img>'                                                                                                                                                     
									} else if (element.childNodes[i].accept.slice(0, -2) == "audio" && element.childNodes[i].outerHTML.includes(filename)) {                                                                                                                              
                                                                                                                                                                                                                                                               
										element.childNodes[i + 1].childNodes[7].outerHTML =                                                                                                                                                                                                  
											'<div class="file-preview"><audio controls type="audio/mpeg" src="data:audio/ogg;base64,' +                                                                                                                                                         
											mediadata + '"</audio>';                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
										var reseticon = element.childNodes[i + 1].getElementsByClassName("btn-icon-only btn-reset");                                                                                                                                                         
										if (reseticon) {                                                                                                                                                                                                                                     
											reseticon.item(0).hidden = true;                                                                                                                                                                                                                    
										}                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
										var feedbacktext = element.childNodes[i + 1].getElementsByClassName("file-feedback error");                                                                                                                                                          
										if (feedbacktext) {                                                                                                                                                                                                                                  
											feedbacktext.item(0).hidden = true;                                                                                                                                                                                                                 
										}                                                                                                                                                                                                                                                    
									} else if (element.childNodes[i].accept.slice(0, -2) == "video" && element.childNodes[i].outerHTML.includes(filename)) {                                                                                                                              
                                                                                                                                                                                                                                                               
										element.childNodes[i + 1].childNodes[7].outerHTML =                                                                                                                                                                                                  
											'<div class="file-preview"><video controls type="video/mp4" src="data:video/mp4;base64,' + mediadata + '"</video>';                                                                                                                                 
                                                                                                                                                                                                                                                               
										var reseticon = element.childNodes[i + 1].getElementsByClassName("btn-icon-only btn-reset");                                                                                                                                                         
										if (reseticon) {                                                                                                                                                                                                                                     
											reseticon.item(0).hidden = true;                                                                                                                                                                                                                    
										}                                                                                                                                                                                                                                                    
										var feedbacktext = element.childNodes[i + 1].getElementsByClassName("file-feedback error");                                                                                                                                                          
										if (feedbacktext) {                                                                                                                                                                                                                                  
											feedbacktext.item(0).hidden = true;                                                                                                                                                                                                                 
										}                                                                                                                                                                                                                                                    
									}                                                                                                                                                                                                                                                     
								}                                                                                                                                                                                                                                                      
							}                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
						})                                                                                                                                                                                                                                                       
						$(".or-appearance-signature").each(function (index, element) {                                                                                                                                                                                           
							var imagetype = '';                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
							for (var i = 0; i < element.childNodes.length; i++) {                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
								var de = element.childNodes[i];                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
								if (element.childNodes[i].accept == undefined) {                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
								} else {                                                                                                                                                                                                                                               
									if (element.childNodes[i].accept.slice(0, -2) == "image" && element.childNodes[i].outerHTML.includes(filename)) {                                                                                                                                     
										imagetype = 'image';                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
										var oCanvasbody = element.childNodes[i + 1].getElementsByClassName("draw-widget__body");                                                                                                                                                             
										if (oCanvasbody) {                                                                                                                                                                                                                                   
											oCanvasbody.item(0).hidden = true;                                                                                                                                                                                                                  
										}                                                                                                                                                                                                                                                    
										var sDiv = '<div class="file-preview"><img src="data:image/png;base64,' + mediadata + '"</img></div>';                                                                                                                                               
										$(".draw-widget__footer").append(sDiv);                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
										var reseticon = element.childNodes[i + 1].getElementsByClassName("btn-icon-only btn-reset");                                                                                                                                                         
										if (reseticon) {                                                                                                                                                                                                                                     
											reseticon.item(0).hidden = true;                                                                                                                                                                                                                    
										}                                                                                                                                                                                                                                                    
										var feedbacktext = element.childNodes[i + 1].getElementsByClassName("draw-widget__feedback");                                                                                                                                                        
										if (feedbacktext) {                                                                                                                                                                                                                                  
											feedbacktext.item(0).hidden = true;                                                                                                                                                                                                                 
										}                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
									}                                                                                                                                                                                                                                                     
								}                                                                                                                                                                                                                                                      
							}                                                                                                                                                                                                                                                       
							///////////////                                                                                                                                                                                                                                         
						})                                                                                                                                                                                                                                                       
					} catch (err) {                                                                                                                                                                                                                                           
						console.log(err)                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
						oBusyIndicatorEditform.close();                                                                                                                                                                                                                          
					}                                                                                                                                                                                                                                                         
					setTimeout(function () {                                                                                                                                                                                                                                  
						loopform();                                                                                                                                                                                                                                              
					}, 2000);                                                                                                                                                                                                                                                 
				},                                                                                                                                                                                                                                                         
				callbackform: function () {                                                                                                                                                                                                                                
					console.log('All done!');                                                                                                                                                                                                                                 
					oBusyIndicatorEditform.close();                                                                                                                                                                                                                           
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
			///////////////////////////////////                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/////start edit scenario changes                                                                                                                                                                                                                             
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		///Handle EnketoForm Submit event*/////                                                                                                                                                                                                                      
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		getfileContent: function (file) {                                                                                                                                                                                                                            
			var that = this;                                                                                                                                                                                                                                            
			const temporaryFileReader = new FileReader();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			return new Promise((resolve, reject) => {                                                                                                                                                                                                                   
				temporaryFileReader.onerror = () => {                                                                                                                                                                                                                      
					temporaryFileReader.abort();                                                                                                                                                                                                                              
					reject(new DOMException("Problem parsing input file."));                                                                                                                                                                                                  
				};                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				temporaryFileReader.onload = () => {                                                                                                                                                                                                                       
					var filedata = [];                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
					var imageBase64 = temporaryFileReader.result.split(",");                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
					filedata.push({                                                                                                                                                                                                                                           
						file: file,                                                                                                                                                                                                                                              
						data: imageBase64[1]                                                                                                                                                                                                                                     
					});                                                                                                                                                                                                                                                       
					resolve(filedata);                                                                                                                                                                                                                                        
					that.filecontent = temporaryFileReader.result;                                                                                                                                                                                                            
					return temporaryFileReader.result;                                                                                                                                                                                                                        
				};                                                                                                                                                                                                                                                         
				temporaryFileReader.readAsDataURL(file);                                                                                                                                                                                                                   
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
		onEnketoFormSubmit: function (oEvent) {                                                                                                                                                                                                                      
			var that = this;                                                                                                                                                                                                                                            
			try {                                                                                                                                                                                                                                                       
				var oBusyIndicatorResp = new sap.m.BusyDialog();                                                                                                                                                                                                           
				oBusyIndicatorResp.setText('Please wait ..form is getting saved and loading attachments');                                                                                                                                                                 
				oBusyIndicatorResp.open();                                                                                                                                                                                                                                 
				//Get filled Form Model from EnketoForm.Js                                                                                                                                                                                                                 
				var oRecord = oEvent.getParameter("formRecord");                                                                                                                                                                                                           
				var isDraft = oEvent.getParameter("isDraft");                                                                                                                                                                                                              
				var files = oEvent.getParameter("files");                                                                                                                                                                                                                  
				var InstanceID = $(oRecord).find("instanceID").text().split(':')[1];                                                                                                                                                                                       
				that._FormInstanceID = InstanceID;                                                                                                                                                                                                                         
				var deprecateduuidstring = $(oRecord).find("deprecatedID").text().split(':')[0];                                                                                                                                                                           
				var deprecatedIDval = $(oRecord).find("deprecatedID").text().split(':')[1];                                                                                                                                                                                
                                                                                                                                                                                                                                                               
				var oRec1 = oRecord.replace("<deprecatedID>uuid:", '');                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				var oRec1 = oRec1.replace(deprecatedIDval, '');                                                                                                                                                                                                            
				var oRec1 = oRec1.replace("</deprecatedID>", '');                                                                                                                                                                                                          
				// //End of Code  for removing Deprecated ID returned by EnketoForm.Js                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
				// Read and Update the /ResponseCaptureSet with key FormInstanceID&nbsp;                                                                                                                                                                                   
				that.FormData = oRec1;                                                                                                                                                                                                                                     
				var formDataHex = that.ascii_to_hex(that.FormData);                                                                                                                                                                                                        
				// var t = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                            
				var oFormModel = this.getView().getModel();                                                                                                                                                                                                                
				oFormModel.setHeaders({                                                                                                                                                                                                                                    
					"X-Requested-With": "X",                                                                                                                                                                                                                                  
				});                                                                                                                                                                                                                                                        
				////***********************start of read Responsecapture before PUT                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				var CreateData = {                                                                                                                                                                                                                                         
					InstanceID: that._FormInstanceID,                                                                                                                                                                                                                         
					FormID: that._FormMetaDataID,                                                                                                                                                                                                                             
					Version: that._FormMetaDataVersion,                                                                                                                                                                                                                       
					WoNum: that._sWorkOrderNumber,                                                                                                                                                                                                                            
					OperationNum: "",                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
					Equipment: "",                                                                                                                                                                                                                                            
					FunctionLocation: "",                                                                                                                                                                                                                                     
					ResponseData: formDataHex,                                                                                                                                                                                                                                
					CreatedOn: new Date(),                                                                                                                                                                                                                                    
					IsDraft: isDraft,                                                                                                                                                                                                                                         
					NonObjType: "",                                                                                                                                                                                                                                           
					OrderType: that._sOrderType                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
				}                                                                                                                                                                                                                                                          
				var createurl = "/ResponseCaptureSet"                                                                                                                                                                                                                      
					////***********************start of update Responsecapture&nbsp;                                                                                                                                                                                          
				oFormModel.create(createurl, CreateData, {                                                                                                                                                                                                                 
					success: function (oData, oResponse) {                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
						////Set the Form in Display mode                                                                                                                                                                                                                         
						var eleEFC = document.getElementById("EnketoFormControl");                                                                                                                                                                                               
						footer = "<div ></div>";                                                                                                                                                                                                                                 
						$("#EnketoFormSubmit").html(footer);                                                                                                                                                                                                                     
						eleEFC.classList.toggle('lock');                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
						var oSaveDraftBtn = that.getView().byId("__xmlview4--btn_saveasdraft");                                                                                                                                                                                  
						var oSubmittBtn = that.getView().byId("__xmlview4--btn_submit");                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
						if (oSaveDraftBtn) {                                                                                                                                                                                                                                     
							oSaveDraftBtn.setVisible(false);                                                                                                                                                                                                                        
						}                                                                                                                                                                                                                                                        
						if (oSubmittBtn) {                                                                                                                                                                                                                                       
							oSubmittBtn.setVisible(false);                                                                                                                                                                                                                          
						}                                                                                                                                                                                                                                                        
						////////                                                                                                                                                                                                                                                 
						console.log("Response created Successfully");                                                                                                                                                                                                            
						MessageToast.show("Response created Successfully", {                                                                                                                                                                                                     
							duration: 3000, // default                                                                                                                                                                                                                              
							width: "30em", // default);                                                                                                                                                                                                                             
						});                                                                                                                                                                                                                                                      
						oBusyIndicatorResp.close();                                                                                                                                                                                                                              
					},                                                                                                                                                                                                                                                        
					error: function (err, oResponse) {                                                                                                                                                                                                                        
						console.log('Response not created .Error while updating record');                                                                                                                                                                                        
						MessageToast.show("Response not created .Error while updating record", {                                                                                                                                                                                 
							duration: 3000, // default                                                                                                                                                                                                                              
							width: "30em", // default);                                                                                                                                                                                                                             
						});                                                                                                                                                                                                                                                      
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				//***loop all file/media and create entry in FormattachmentSet                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
				for (var i = 0; i < files.length; i++) {                                                                                                                                                                                                                   
					var filecontent = that.getfileContent(files[i]);                                                                                                                                                                                                          
					filecontent.then(function (filedata) {                                                                                                                                                                                                                    
						////********************start update the attachments/signature / media files                                                                                                                                                                             
						var imagedata = filedata[0].data;                                                                                                                                                                                                                        
						var oFileAttach = {                                                                                                                                                                                                                                      
							InstanceId: that._FormInstanceID,                                                                                                                                                                                                                       
							FormId: that._FormMetaDataID,                                                                                                                                                                                                                           
							Version: that._FormMetaDataVersion,                                                                                                                                                                                                                     
							AttachCounter: "0000" + Math.floor(1000 + Math.random() * 9000),                                                                                                                                                                                        
							FileName: filedata[0].file.name,                                                                                                                                                                                                                        
							MimeType: filedata[0].file.type,                                                                                                                                                                                                                        
							ObjectNum: that._sWorkOrderNumber,                                                                                                                                                                                                                      
							ImageData: imagedata,                                                                                                                                                                                                                                   
							CreatedOn: new Date()                                                                                                                                                                                                                                   
						}                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
						console.log(oFileAttach);                                                                                                                                                                                                                                
						var updateurl = "/FormAttachmentSet";                                                                                                                                                                                                                    
						oFormModel.create(updateurl, oFileAttach, {                                                                                                                                                                                                              
							success: function (oData, oResponse) {                                                                                                                                                                                                                  
								console.log("Attachement Record Updated Successfully");                                                                                                                                                                                                
							},                                                                                                                                                                                                                                                      
							error: function (err, oResponse) {                                                                                                                                                                                                                      
								console.log('Attachment record not updated .Error while updating record');                                                                                                                                                                             
                                                                                                                                                                                                                                                               
							}                                                                                                                                                                                                                                                       
						});                                                                                                                                                                                                                                                      
						// 		//end update the attachments/signature / media files                                                                                                                                                                                                
					})                                                                                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
				////start get form attachments get                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				this.oResourceBundle = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                
				var stext = this.oResourceBundle.getText("AttachBusyMsgLong");                                                                                                                                                                                             
				var oBusyIndicator = new sap.m.BusyDialog();                                                                                                                                                                                                               
				oBusyIndicator.setText(stext);                                                                                                                                                                                                                             
				oBusyIndicator.open();                                                                                                                                                                                                                                     
				setTimeout(function () {                                                                                                                                                                                                                                   
					var oAttachments = that.returnFormAttachments(that._FormInstanceID);                                                                                                                                                                                      
					oAttachments.then(function (data) {                                                                                                                                                                                                                       
						var array = data.results;                                                                                                                                                                                                                                
						that.getEditForm(array);                                                                                                                                                                                                                                 
						oBusyIndicator.close();                                                                                                                                                                                                                                  
					}.bind(this)).catch(function (oerror) {                                                                                                                                                                                                                   
						console.log('Attachments record not found .');                                                                                                                                                                                                           
						oBusyIndicator.close();                                                                                                                                                                                                                                  
					}.bind(this));                                                                                                                                                                                                                                            
				}, 15000);                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
				///end attachments get                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			} catch (err) {                                                                                                                                                                                                                                             
				alert('Error in Saving updated Form');                                                                                                                                                                                                                     
				oBusyIndicatorResp.close();                                                                                                                                                                                                                                
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onSaveAsDraftPress: function (oEvent) {                                                                                                                                                                                                                      
			$("#save-as-draft").trigger("click");                                                                                                                                                                                                                       
		},                                                                                                                                                                                                                                                           
		onSubmitPress: function (oEvent) {                                                                                                                                                                                                                           
			$("#validate-form").trigger("click");                                                                                                                                                                                                                       
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/////end edit scenario changes                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// BUTTON EVENTS                                                                                                                                                                                                                                             
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		onExpand: function (oEvent) {                                                                                                                                                                                                                                
			////// code for expanding  sections                                                                                                                                                                                                                         
			var coll = document.getElementsByClassName("or-appearance-compact");                                                                                                                                                                                        
			var collLength = coll.length;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			for (i = collLength; i >= 0; i--) {                                                                                                                                                                                                                         
				var element = coll[i];                                                                                                                                                                                                                                     
				if (element) {                                                                                                                                                                                                                                             
					element.classList.remove('or-appearance-compact');                                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
		onCollapse: function (oEvent) {                                                                                                                                                                                                                              
			//// code for collapsing sections                                                                                                                                                                                                                           
			var coll = document.getElementsByClassName("or-group");                                                                                                                                                                                                     
			var collLength = coll.length;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			for (i = collLength; i >= 0; i--) {                                                                                                                                                                                                                         
				var element = coll[i];                                                                                                                                                                                                                                     
				if (element) {                                                                                                                                                                                                                                             
					element.classList.add('or-appearance-compact');                                                                                                                                                                                                           
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onPrint: function (oEvent, sText) {                                                                                                                                                                                                                          
			this.oResourceBundle = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                 
			if (!sText) {                                                                                                                                                                                                                                               
				sText = this.oResourceBundle.getText("PrintBusyMsgLong"); ////"Please wait while the form print preview is opened...";                                                                                                                                     
			}                                                                                                                                                                                                                                                           
			var that = this;                                                                                                                                                                                                                                            
			var coll = document.getElementsByClassName("or-appearance-compact");                                                                                                                                                                                        
			var collLength = coll.length;                                                                                                                                                                                                                               
			if (collLength) {                                                                                                                                                                                                                                           
				alert(this.oResourceBundle.getText("PrintAlertMsgLong"));                                                                                                                                                                                                  
				for (i = collLength; i >= 0; i--) {                                                                                                                                                                                                                        
					var element = coll[i];                                                                                                                                                                                                                                    
					if (element) {                                                                                                                                                                                                                                            
						element.classList.remove('or-appearance-compact');                                                                                                                                                                                                       
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			//// call the Print function in the setTimeout by giving delay to have the pre-loading of the css 			                                                                                                                                                       
			setTimeout(function () {                                                                                                                                                                                                                                    
				var oBusyIndicator = new sap.m.BusyDialog();                                                                                                                                                                                                               
				oBusyIndicator.setText(sText);                                                                                                                                                                                                                             
				oBusyIndicator.open();                                                                                                                                                                                                                                     
				var locPath = window.location.pathname;                                                                                                                                                                                                                    
				var vGui = locPath.search("ui5_ui5");                                                                                                                                                                                                                      
				if (vGui >= "0") {                                                                                                                                                                                                                                         
					var cssPath = window.location.origin + "/sap/bc/ui5_ui5/odsmfe/bsp_form_ui/lib/css/grid.css";                                                                                                                                                             
				} else if (locPath.search("webapp/") >= "0") {                                                                                                                                                                                                             
					var cssPath = window.location.origin + "/webapp/lib/css/grid.css";                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
				//// Print function                                                                                                                                                                                                                                        
				$("#EnketoFormBody").printThis({                                                                                                                                                                                                                           
					debug: false, //// show the iframe for debugging                                                                                                                                                                                                          
					importCSS: true, //// import parent page css                                                                                                                                                                                                              
					importStyle: false, //// import style tags                                                                                                                                                                                                                
					printContainer: true, //// print outer container/$.selector                                                                                                                                                                                               
					loadCSS: cssPath, //// path to additional css file - use an array [] for multiple                                                                                                                                                                         
					pageTitle: "", //// add title to print page                                                                                                                                                                                                               
					removeInline: false, //// remove inline styles from print elements                                                                                                                                                                                        
					removeInlineSelector: "*", //// custom selectors to filter inline styles. removeInline must be true                                                                                                                                                       
					printDelay: 4000, //// variable print delay                                                                                                                                                                                                               
					header: null, //// prefix to html                                                                                                                                                                                                                         
					footer: null, //// postfix to html                                                                                                                                                                                                                        
					base: false, //// preserve the BASE tag or accept a string for the URL                                                                                                                                                                                    
					formValues: true, // preserve input/form values                                                                                                                                                                                                           
					canvas: true, //// copy canvas content                                                                                                                                                                                                                    
					doctypeString: '', //// enter a different doctype for older markup                                                                                                                                                                                        
					removeScripts: false, //// remove script tags from print content                                                                                                                                                                                          
					copyTagClasses: false, //// copy classes from the html & body tag                                                                                                                                                                                         
					beforePrintEvent: null, //// function for printEvent in iframe                                                                                                                                                                                            
					beforePrint: null, //// function called before iframe is filled                                                                                                                                                                                           
					afterPrint: function () {                                                                                                                                                                                                                                 
							oBusyIndicator.close();                                                                                                                                                                                                                                 
						} //// function called before iframe is removed                                                                                                                                                                                                          
				});                                                                                                                                                                                                                                                        
			}, that.delay);                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		//// PDF functionality                                                                                                                                                                                                                                       
		onPDFPress: function () {                                                                                                                                                                                                                                    
			this.oResourceBundle = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                 
			try {                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				var that = this;                                                                                                                                                                                                                                           
				var coll = document.getElementsByClassName("or-appearance-compact");                                                                                                                                                                                       
				var collLength = coll.length;                                                                                                                                                                                                                              
				if (collLength) {                                                                                                                                                                                                                                          
					alert(this.oResourceBundle.getText("PDFAlertMsgLong"));                                                                                                                                                                                                   
					for (i = collLength; i >= 0; i--) {                                                                                                                                                                                                                       
						var element = coll[i];                                                                                                                                                                                                                                   
						if (element) {                                                                                                                                                                                                                                           
							element.classList.remove('or-appearance-compact');                                                                                                                                                                                                      
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
				var source = $("#EnketoFormBody")[0];                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
				if (source.clientHeight > 13000) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
					////// call the Print functionality to get "save as PDF"                                                                                                                                                                                                  
					var sText = this.oResourceBundle.getText("PrintBusyMsgShort");                                                                                                                                                                                            
					this.onPrint('', sText);                                                                                                                                                                                                                                  
				} else {                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
					//// PDF processing for forms with less pages                                                                                                                                                                                                             
					var oBusyIndicator = new sap.m.BusyDialog();                                                                                                                                                                                                              
					oBusyIndicator.setText(this.oResourceBundle.getText("PDFBusyMsgShort")); //"Please wait while the form is getting Downloaded...");                                                                                                                        
					oBusyIndicator.open();                                                                                                                                                                                                                                    
					////Get Source  for PDF generation				                                                                                                                                                                                                                    
					var that = this;                                                                                                                                                                                                                                          
					var source = $("#EnketoFormBody")[0];                                                                                                                                                                                                                     
					var doc = new jsPDF('p', 'mm');                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
					////Prepare PDF file name				                                                                                                                                                                                                                             
					// var oFormModel = this.getView().getModel();                                                                                                                                                                                                            
					// var sFormid = oFormModel.getProperty(this._sFormCreatePath + "/FormId");                                                                                                                                                                               
					// var sWoNum = oFormModel.getProperty(this._sFormCreatePath + "/WoNum");                                                                                                                                                                                 
					// var sVersion = oFormModel.getProperty(this._sFormCreatePath + "/Version");                                                                                                                                                                             
					// var sfilename = sWoNum + "_" + sFormid + "_" + sVersion + ".pdf";                                                                                                                                                                                      
					var sfilename = that._sWorkOrderNumber + "_" + that._FormMetaDataID + "_" + that._FormMetaDataVersion + ".pdf";                                                                                                                                           
					////fill options for DOM to Image function				                                                                                                                                                                                                            
					var options = {                                                                                                                                                                                                                                           
						background: 'white',                                                                                                                                                                                                                                     
						height: source.clientHeight,                                                                                                                                                                                                                             
						width: 1350                                                                                                                                                                                                                                              
					};                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
					//// Call the function domtoimage&nbsp;                                                                                                                                                                                                                   
					domtoimage.toPng(source, options).then((dataUrl) => {                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
						var pageHeight = doc.internal.pageSize.height;                                                                                                                                                                                                           
						var pageWidth = doc.internal.pageSize.width;                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
						var imgheight = source.clientHeight * 25.4 / 96; //px to mm                                                                                                                                                                                              
						var pagecount = Math.ceil(imgheight / pageHeight);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
						/* add initial page */                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
						doc.addImage(dataUrl, 'PNG', 2, 0, pageWidth - 1, 0);                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
						/* add extra pages if the div size is larger than a a4 size */                                                                                                                                                                                           
						if (pagecount > 0) {                                                                                                                                                                                                                                     
							var j = 1;                                                                                                                                                                                                                                              
							while (j != pagecount) {                                                                                                                                                                                                                                
								doc.addPage('l', 'mm', 'a3');                                                                                                                                                                                                                          
								doc.addImage(dataUrl, 'PNG', 2, -(j * pageHeight), pageWidth - 1, 0);                                                                                                                                                                                  
								j++;                                                                                                                                                                                                                                                   
							}                                                                                                                                                                                                                                                       
						}                                                                                                                                                                                                                                                        
						oBusyIndicator.close();                                                                                                                                                                                                                                  
						doc.save(sfilename);                                                                                                                                                                                                                                     
					}).catch(function (error) {                                                                                                                                                                                                                               
						oBusyIndicator.close();                                                                                                                                                                                                                                  
						var sText = that.oResourceBundle.getText("PrintBusyMsgShort");                                                                                                                                                                                           
						that.onPrint('', sText);                                                                                                                                                                                                                                 
					});                                                                                                                                                                                                                                                       
				}                                                                                                                                                                                                                                                          
			} catch (err) {                                                                                                                                                                                                                                             
				alert(err.message);                                                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		//End of insert by EVURIA&nbsp;                                                                                                                                                                                                                              
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// Utilities                                                                                                                                                                                                                                                 
		/////////////////////////////////////////////////////////		                                                                                                                                                                                                  
		_hex_to_ascii: function (str1) {                                                                                                                                                                                                                             
			if (str1 === undefined || str1 == null || str1.length <= 0) {                                                                                                                                                                                               
				return "";                                                                                                                                                                                                                                                 
			}                                                                                                                                                                                                                                                           
			var hex = str1.toString();                                                                                                                                                                                                                                  
			var str = '';                                                                                                                                                                                                                                               
			for (var n = 0; n < hex.length; n += 2) {                                                                                                                                                                                                                   
				str += String.fromCharCode(parseInt(hex.substr(n, 2), 16));                                                                                                                                                                                                
			}                                                                                                                                                                                                                                                           
			return str;                                                                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
		ascii_to_hex: function (xml) {                                                                                                                                                                                                                               
			var hex, i;                                                                                                                                                                                                                                                 
			var result = "";                                                                                                                                                                                                                                            
			for (i = 0; i < xml.length; i++) {                                                                                                                                                                                                                          
				hex = xml.charCodeAt(i).toString(16);                                                                                                                                                                                                                      
				result += ("0" + hex).slice(-2);                                                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
			return result;                                                                                                                                                                                                                                              
		},                                                                                                                                                                                                                                                           
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// LAYOUT EVENTS                                                                                                                                                                                                                                             
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Set the full screen mode to false and navigate to master page                                                                                                                                                                                             
		 */                                                                                                                                                                                                                                                          
		onCloseDetailPress: function () {                                                                                                                                                                                                                            
			var oModel = this.getView().getModel("app");                                                                                                                                                                                                                
			oModel.setProperty("/actionButtonsInfo/endColumn/fullScreen", false);                                                                                                                                                                                       
			// No item should be selected on master after detail page is closed                                                                                                                                                                                         
			// this._sWorkOrderNumber = oModel.getProperty("/selectedWorkOrder");                                                                                                                                                                                       
			this.getOwnerComponent().getRouter().navTo("TargetWorkOrderFormList", {                                                                                                                                                                                     
				WorkOrderNumber: this._sWorkOrderNumber                                                                                                                                                                                                                    
			}, true);                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Toggle between full and non full screen mode.                                                                                                                                                                                                             
		 */                                                                                                                                                                                                                                                          
		toggleFullScreen: function () {                                                                                                                                                                                                                              
			var oModel = this.getView().getModel("app");                                                                                                                                                                                                                
			var bFullScreen = oModel.getProperty("/actionButtonsInfo/endColumn/fullScreen");                                                                                                                                                                            
			oModel.setProperty("/actionButtonsInfo/endColumn/fullScreen", !bFullScreen);                                                                                                                                                                                
			if (!bFullScreen) {                                                                                                                                                                                                                                         
				//// store current layout and go full screen                                                                                                                                                                                                               
				oModel.setProperty("/previousLayout", oModel.getProperty("/layout"));                                                                                                                                                                                      
				oModel.setProperty("/layout", "EndColumnFullScreen");                                                                                                                                                                                                      
			} else {                                                                                                                                                                                                                                                    
				//// reset to previous layout                                                                                                                                                                                                                              
				oModel.setProperty("/layout", oModel.getProperty("/previousLayout"));                                                                                                                                                                                      
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            