sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"sap/ui/core/Fragment",                                                                                                                                                                                                                                       
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
	"sap/ui/model/Sorter",                                                                                                                                                                                                                                        
	"sap/ui/core/format/DateFormat",                                                                                                                                                                                                                              
	"sap/ui/Device",                                                                                                                                                                                                                                              
	"odsmfe/FormUI/model/formatter",                                                                                                                                                                                                                              
	"sap/m/MessageBox",                                                                                                                                                                                                                                           
	"sap/ui/core/routing/History",                                                                                                                                                                                                                                
	"sap/ui/core/UIComponent",                                                                                                                                                                                                                                    
	"sap/ui/core/ValueState",                                                                                                                                                                                                                                     
	"sap/ui/model/odata/v2/ODataModel",                                                                                                                                                                                                                           
	"sap/m/MessageToast",                                                                                                                                                                                                                                         
	"sap/m/GroupHeaderListItem"                                                                                                                                                                                                                                   
], function (Controller, Fragment, Filter, FilterOperator, Sorter, DateFormat, Device, formatter, MessageBox, History, UIComponent,                                                                                                                            
	ValueState,                                                                                                                                                                                                                                                   
	ODataModel, MessageToast, GroupHeaderListItem) {                                                                                                                                                                                                              
	"use strict";                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
	return Controller.extend("odsmfe.FormUI.controller.WorkOrderFormList", {                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// VARIABLES                                                                                                                                                                                                                                                 
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		formatter: formatter,                                                                                                                                                                                                                                        
		_WorkOrderNumber: null,                                                                                                                                                                                                                                      
		_OrderType: null,                                                                                                                                                                                                                                            
		_FormMetaDataID: null,                                                                                                                                                                                                                                       
		_FormMetaDataVersion: null,                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
		_oDialog: null,                                                                                                                                                                                                                                              
		_fromCreate: false,                                                                                                                                                                                                                                          
		_oEditDialog: null,                                                                                                                                                                                                                                          
		_dateFormat: DateFormat.getDateInstance({                                                                                                                                                                                                                    
			pattern: "dd/MM/YYYY hh:mm"                                                                                                                                                                                                                                 
		}),                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// CONTROLLER LIFECYCLE EVENTS                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		onInit: function () {                                                                                                                                                                                                                                        
			var oRouter = sap.ui.core.UIComponent.getRouterFor(this);                                                                                                                                                                                                   
			oRouter.getRoute("TargetWorkOrderFormList").attachMatched(this.__onRouteMatched, this);                                                                                                                                                                     
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		__onRouteMatched: function (oEvent) {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			var that = this;                                                                                                                                                                                                                                            
			this._WorkOrderNumber = oEvent.getParameter("arguments").WorkOrderNumber;                                                                                                                                                                                   
			var appModel = this.getView().getModel("app");                                                                                                                                                                                                              
			var selectedOrderType = appModel.getProperty("/selectedOrderType");                                                                                                                                                                                         
			if (this._WorkOrderNumber === null || typeof (this._WorkOrderNumber) === "undefined") {                                                                                                                                                                     
                                                                                                                                                                                                                                                               
				var selectedWorkOrder = appModel.getProperty("/selectedWorkOrder");                                                                                                                                                                                        
				this._WorkOrderNumber = selectedWorkOrder;                                                                                                                                                                                                                 
			} else {                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				var selectedWorkOrder = appModel.getProperty("/selectedWorkOrder");                                                                                                                                                                                        
				if (!selectedWorkOrder) {                                                                                                                                                                                                                                  
					appModel.setProperty("/selectedWorkOrder", this._WorkOrderNumber);                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			if (this._OrderType === null || typeof (this._OrderType) === "undefined") {                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
				var selectedOrderType = appModel.getProperty("/selectedOrderType");                                                                                                                                                                                        
				this._OrderType = selectedOrderType;                                                                                                                                                                                                                       
			} else {                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				var selectedOrderType = appModel.getProperty("/selectedOrderType");                                                                                                                                                                                        
				if (!selectedOrderType) {                                                                                                                                                                                                                                  
					appModel.setProperty("/selectedOrderType", this._OrderType);                                                                                                                                                                                              
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
			var sPath = "/WorkOrderSet(WorkOrderNumber='" + this._WorkOrderNumber + "'," + "OrderType='" + this._OrderType + "')";                                                                                                                                      
			this.getView().bindElement({                                                                                                                                                                                                                                
				path: sPath,                                                                                                                                                                                                                                               
				events: {                                                                                                                                                                                                                                                  
					dataRequested: function () {                                                                                                                                                                                                                              
						that.getView().setBusy(true);                                                                                                                                                                                                                            
					},                                                                                                                                                                                                                                                        
					dataReceived: function () {                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
						that.getView().setBusy(false);                                                                                                                                                                                                                           
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onExit: function () {},                                                                                                                                                                                                                                      
		getFormID: function (oContext) {                                                                                                                                                                                                                             
			return oContext.getProperty('FormID');                                                                                                                                                                                                                      
		},                                                                                                                                                                                                                                                           
		getVersion: function (oContext) {                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
			return oContext.getProperty('Version');                                                                                                                                                                                                                     
		},                                                                                                                                                                                                                                                           
		getGroupHeader: function (oGroup) {                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			return new GroupHeaderListItem({                                                                                                                                                                                                                            
				title: oGroup.key,                                                                                                                                                                                                                                         
				upperCase: false                                                                                                                                                                                                                                           
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// LAYOUT EVENTS                                                                                                                                                                                                                                             
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Set the full screen mode to false and navigate to master page                                                                                                                                                                                             
		 */                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
		onCloseDetailPress: function () {                                                                                                                                                                                                                            
			var oModel = this.getView().getModel("app");                                                                                                                                                                                                                
			oModel.setProperty("/actionButtonsInfo/midColumn/fullScreen", false);                                                                                                                                                                                       
			// No item should be selected on master after detail page is closed                                                                                                                                                                                         
			this.getOwnerComponent().getRouter().navTo("TargetWorkOrderList", {}, true);                                                                                                                                                                                
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Toggle between full and non full screen mode.                                                                                                                                                                                                             
		 */                                                                                                                                                                                                                                                          
		toggleFullScreen: function () {                                                                                                                                                                                                                              
			var oModel = this.getView().getModel("app");                                                                                                                                                                                                                
			var bFullScreen = oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");                                                                                                                                                                            
			oModel.setProperty("/actionButtonsInfo/midColumn/fullScreen", !bFullScreen);                                                                                                                                                                                
			if (!bFullScreen) {                                                                                                                                                                                                                                         
				// store current layout and go full screen                                                                                                                                                                                                                 
				oModel.setProperty("/previousLayout", oModel.getProperty("/layout"));                                                                                                                                                                                      
				oModel.setProperty("/layout", "MidColumnFullScreen");                                                                                                                                                                                                      
			} else {                                                                                                                                                                                                                                                    
				// reset to previous layout                                                                                                                                                                                                                                
				oModel.setProperty("/layout", oModel.getProperty("/previousLayout"));                                                                                                                                                                                      
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onViewDisplayForm: function (oEvent) {                                                                                                                                                                                                                       
			var oItem = oEvent.getParameter("listItem");                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			var sFormInstanceID = oItem.getBindingContext().getProperty("InstanceID");                                                                                                                                                                                  
			var sMode = "Display";                                                                                                                                                                                                                                      
			var oModel = this.getView().getModel("app");                                                                                                                                                                                                                
			oModel.setProperty("/selectedFormInstanceID", sFormInstanceID);                                                                                                                                                                                             
			oModel.setProperty("/selectedMode", sMode);                                                                                                                                                                                                                 
			this.getOwnerComponent().getRouter().navTo("TargetForm", {                                                                                                                                                                                                  
				FormInstanceID: sFormInstanceID,                                                                                                                                                                                                                           
				Mode: sMode                                                                                                                                                                                                                                                
			}, true);                                                                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
		onEditForm: function (oEvent) {                                                                                                                                                                                                                              
			////new logic for the button row info&nbsp;                                                                                                                                                                                                                 
			var oButton = oEvent.getSource();                                                                                                                                                                                                                           
			var oBindingContext = oButton.getBindingContext(); // <<<-- If you have model name pass it here as string                                                                                                                                                   
			var oBindingObject = oBindingContext.getObject(); // getPath() method gives path to model row number                                                                                                                                                        
                                                                                                                                                                                                                                                               
			var sFormInstanceID = oBindingObject.InstanceID;                                                                                                                                                                                                            
			var sMode = "Edit";                                                                                                                                                                                                                                         
			var oModel = this.getView().getModel("app");                                                                                                                                                                                                                
			oModel.setProperty("/selectedFormInstanceID", sFormInstanceID);                                                                                                                                                                                             
			oModel.setProperty("/selectedMode", sMode);                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			this.getOwnerComponent().getRouter().navTo("TargetForm", {                                                                                                                                                                                                  
				FormInstanceID: sFormInstanceID,                                                                                                                                                                                                                           
				Mode: sMode                                                                                                                                                                                                                                                
			}, true);                                                                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onCreateForm: function (oEvent) {                                                                                                                                                                                                                            
			var oButton = oEvent.getSource();                                                                                                                                                                                                                           
			var that = this;                                                                                                                                                                                                                                            
			if (!this._oDialog) {                                                                                                                                                                                                                                       
				Fragment.load({                                                                                                                                                                                                                                            
					name: "odsmfe.FormUI.view.fragment.dialog.AvailableFormsDialog",                                                                                                                                                                                          
					controller: this                                                                                                                                                                                                                                          
				}).then(function (oDialog) {                                                                                                                                                                                                                               
					this._oDialog = oDialog;                                                                                                                                                                                                                                  
					this._oDialog.setModel(this.getView().getModel());                                                                                                                                                                                                        
					this.getView().addDependent(this._oDialog);                                                                                                                                                                                                               
					this._configDialog(oButton);                                                                                                                                                                                                                              
					this._oDialog.open();                                                                                                                                                                                                                                     
				}.bind(this));                                                                                                                                                                                                                                             
			} else {                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				this._oDialog.setModel(this.getView().getModel());                                                                                                                                                                                                         
				this.getView().addDependent(this._oDialog);                                                                                                                                                                                                                
				this._configDialog(oButton);                                                                                                                                                                                                                               
				this._oDialog.open();                                                                                                                                                                                                                                      
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
		_configDialog: function (oButton) {                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			var sCustomConfirmButtonText = oButton.data("confirmButtonText");                                                                                                                                                                                           
			this._oDialog.setConfirmButtonText("Create");                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onDialogClose: function (oEvent) {                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var aContexts = oEvent.getParameter("selectedContexts");                                                                                                                                                                                                    
			if (aContexts && aContexts.length) {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				var FormID = aContexts.map(function (oContext) {                                                                                                                                                                                                           
					return oContext.getObject().FormId;                                                                                                                                                                                                                       
				});                                                                                                                                                                                                                                                        
				var FormVersion = aContexts.map(function (oContext) {                                                                                                                                                                                                      
					return oContext.getObject().Version;                                                                                                                                                                                                                      
				});                                                                                                                                                                                                                                                        
				var submissions = aContexts.map(function (oContext) {                                                                                                                                                                                                      
					return oContext.getObject().Submitted;                                                                                                                                                                                                                    
				});                                                                                                                                                                                                                                                        
				var allowed = aContexts.map(function (oContext) {                                                                                                                                                                                                          
					return oContext.getObject().Occurances;                                                                                                                                                                                                                   
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				var MultipleSub = aContexts.map(function (oContext) {                                                                                                                                                                                                      
					return oContext.getObject().MultipleSub;                                                                                                                                                                                                                  
				});                                                                                                                                                                                                                                                        
				console.log('Create Form' + FormID);                                                                                                                                                                                                                       
				var appModel = this.getView().getModel("app");                                                                                                                                                                                                             
				appModel.setProperty("/selectedWorkOrder", this._WorkOrderNumber);                                                                                                                                                                                         
				appModel.setProperty("/selectedOrderType", this._OrderType);                                                                                                                                                                                               
			} else {                                                                                                                                                                                                                                                    
				MessageToast.show("No new item was selected.", {                                                                                                                                                                                                           
					duration: 3000, // default                                                                                                                                                                                                                                
					width: "30em", // default);                                                                                                                                                                                                                               
				});                                                                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                           
			oEvent.getSource().getBinding("items").filter([]);                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			var oSubcount = new sap.ui.model.type.Integer({                                                                                                                                                                                                             
				minIntegerDigits: 3                                                                                                                                                                                                                                        
			});                                                                                                                                                                                                                                                         
			var oAllowedcount = new sap.ui.model.type.Integer({                                                                                                                                                                                                         
				minIntegerDigits: 3                                                                                                                                                                                                                                        
			});                                                                                                                                                                                                                                                         
			oSubcount = parseInt(submissions[0]);                                                                                                                                                                                                                       
			oAllowedcount = parseInt(allowed[0]);                                                                                                                                                                                                                       
			var sMode = "Create";                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			if (MultipleSub = "X") {                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				if (oSubcount < oAllowedcount || oAllowedcount == 0) {                                                                                                                                                                                                     
					this.getOwnerComponent().getRouter().navTo("TargetFormCreate", {                                                                                                                                                                                          
						WorkOrder: this._WorkOrderNumber,                                                                                                                                                                                                                        
						FormMetaDataID: FormID[0],                                                                                                                                                                                                                               
						Version: FormVersion[0],                                                                                                                                                                                                                                 
						Mode: sMode                                                                                                                                                                                                                                              
					}, true);                                                                                                                                                                                                                                                 
				} else {                                                                                                                                                                                                                                                   
					MessageToast.show("No more submissions allowed for the FormID:" + FormID[0] + "     " + "Version:" + FormVersion[0], {                                                                                                                                    
						duration: 6000, // default                                                                                                                                                                                                                               
						width: "60em" // default                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
					});                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				}                                                                                                                                                                                                                                                          
			} else {                                                                                                                                                                                                                                                    
				if (oSubcount < "1") {                                                                                                                                                                                                                                     
					this.getOwnerComponent().getRouter().navTo("TargetFormCreate", {                                                                                                                                                                                          
						WorkOrder: this._WorkOrderNumber,                                                                                                                                                                                                                        
						FormMetaDataID: FormID[0],                                                                                                                                                                                                                               
						Version: FormVersion[0],                                                                                                                                                                                                                                 
						Mode: sMode                                                                                                                                                                                                                                              
					}, true);                                                                                                                                                                                                                                                 
				} else {                                                                                                                                                                                                                                                   
					MessageToast.show("No more submissions allowed for the FormID:" + FormID[0] + "Version:" + FormVersion[0], {                                                                                                                                              
						duration: 6000, // default                                                                                                                                                                                                                               
						width: "60em" // default                                                                                                                                                                                                                                 
					});                                                                                                                                                                                                                                                       
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		// FILTERBAR EVENTS                                                                                                                                                                                                                                          
		/////////////////////////////////////////////////////////                                                                                                                                                                                                    
		//// start:code for setting the submission count                                                                                                                                                                                                             
		onUpdateFinished: function (oEvent) {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				var oDataModel = this.getView().getModel("data");                                                                                                                                                                                                          
				oDataModel.setProperty("/FormList/count", oEvent.getSource().getBinding("items").getLength());                                                                                                                                                             
				var DraftCount = 0;                                                                                                                                                                                                                                        
				var SubCount = 0;                                                                                                                                                                                                                                          
				var oItems = oEvent.getSource().getBinding("items").getContexts();                                                                                                                                                                                         
				var oTable = this.getView().byId("tableWorkOrderFormList");                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
				var otabItems = [];                                                                                                                                                                                                                                        
				for (var i = 0; i < oTable.getItems().length; i++) {                                                                                                                                                                                                       
					if (oTable.getItems()[i]) {                                                                                                                                                                                                                               
						if (oTable.getItems()[i].isGroupHeader() == false) {                                                                                                                                                                                                     
							otabItems.push(oTable.getItems()[i]);                                                                                                                                                                                                                   
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
				var i = 0;                                                                                                                                                                                                                                                 
				oItems.forEach(function (r) {                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
					var obj = r.getObject();                                                                                                                                                                                                                                  
					var operationnum = obj.OperationNum;                                                                                                                                                                                                                      
					var equip = obj.Equipment;                                                                                                                                                                                                                                
					var funloc = obj.FunctionLocation;                                                                                                                                                                                                                        
					var sAssignmentText = null;                                                                                                                                                                                                                               
					if (obj.OperationNum) {                                                                                                                                                                                                                                   
						sAssignmentText = 'Assigned to Operation: ' + obj.OperationNum;                                                                                                                                                                                          
					} else if (obj.Equipment) {                                                                                                                                                                                                                               
						sAssignmentText = 'Assigned to Equipment: ' + obj.Equipment;                                                                                                                                                                                             
					} else if (obj.FunctionLocation) {                                                                                                                                                                                                                        
						sAssignmentText = 'Assigned to FunctionLocation: ' + obj.FunctionLocation;                                                                                                                                                                               
					}                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
					if (otabItems[i]) {                                                                                                                                                                                                                                       
						if (otabItems[i].isGroupHeader() == false) {                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
							otabItems[i].getCells()[0].setText(sAssignmentText);                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
					i++;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
			////end:code for setting the submission count                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            